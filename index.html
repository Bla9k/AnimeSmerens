<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AnimeSmerens | Archive</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel Standalone (Required for JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;700&family=Space+Grotesk:wght@300;400;500;600&display=swap" rel="stylesheet">

    <!-- Styles -->
    <style>
        :root {
            --accent: #facc15;
        }
        body {
            background-color: #050505;
            color: white;
            margin: 0;
            overflow-x: hidden;
            font-family: 'Space Grotesk', sans-serif;
            -webkit-font-smoothing: antialiased;
        }
        
        /* Font Families */
        .font-oswald { font-family: 'Oswald', sans-serif; }
        .font-grotesk { font-family: 'Space Grotesk', sans-serif; }

        /* Scrollbar Hiding */
        ::-webkit-scrollbar { display: none; }
        * { -ms-overflow-style: none; scrollbar-width: none; }

        /* Text Effects */
        .text-stroke {
            -webkit-text-stroke: 2px rgba(255, 255, 255, 0.5);
            color: transparent;
        }
        .text-stroke-thin {
            -webkit-text-stroke: 1px rgba(255, 255, 255, 0.3);
            color: transparent;
        }

        /* Utilities */
        .accent-text { color: var(--accent); transition: color 1s ease; }
        .accent-bg { background-color: var(--accent); transition: background-color 1s ease; }
        
        .mask-linear-gradient {
            mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent);
            -webkit-mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent);
        }

        /* Selection */
        ::selection {
            background: var(--accent);
            color: black;
        }
        
        button, a { cursor: pointer; }
    </style>

    <!-- Import Map for React & Framer Motion -->
    <!-- FIX: Added ?external=react,react-dom to prevent duplicate React instances -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "framer-motion": "https://esm.sh/framer-motion@10.16.4?external=react,react-dom",
        "lucide-react": "https://esm.sh/lucide-react@0.292.0?external=react,react-dom"
      }
    }
    </script>
</head>
<body>
    <div id="root"></div>

    <!-- Application Logic -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import ReactDOM from 'react-dom/client';
        import { motion, useScroll, useTransform, useSpring, useInView, useMotionValue, AnimatePresence, useAnimate, stagger } from 'framer-motion';
        import { Star, TrendingUp, Users, Clock, Play, Heart, ArrowUpRight, Search, X, Hash, Shuffle, ChevronLeft, ChevronRight } from 'lucide-react';

        // --- CONSTANTS ---
        const KANJI_CHARS = ["序", "破", "急", "壱", "弐", "参", "零", "無", "空", "幻", "影", "響"];
        const GENRES = ["Action", "Adventure", "Cyberpunk", "Drama", "Ecchi", "Fantasy", "Horror", "Mecha", "Music", "Mystery", "Psychological", "Romance", "Sci-Fi", "Slice of Life", "Sports", "Supernatural", "Thriller"];

        const HERO_SLIDES = [
            {
                id: 'edgerunners',
                query: 'Cyberpunk: Edgerunners',
                color: '#facc15', // Yellow-400
                image: 'https://images.unsplash.com/photo-1555680202-c86f0e12f086?q=80&w=2070&auto=format&fit=crop', 
            },
            {
                id: 'bleach',
                query: 'Bleach: Thousand-Year Blood War',
                color: '#f97316', // Orange-500
                image: 'https://images.unsplash.com/photo-1578632767115-351597cf2477?q=80&w=2070&auto=format&fit=crop',
            },
            {
                id: 'chainsaw',
                query: 'Chainsaw Man',
                color: '#14b8a6', // Teal-500
                image: 'https://images.unsplash.com/photo-1618336753974-aae8e04506aa?q=80&w=2070&auto=format&fit=crop',
            },
            {
                id: 'jjk',
                query: 'Jujutsu Kaisen',
                color: '#ef4444', // Red-500
                image: 'https://images.unsplash.com/photo-1518709268805-4e9042af9f23?q=80&w=2068&auto=format&fit=crop',
            }
        ];

        // --- COMPONENTS ---

        // 1. INTRO SEQUENCE
        const IntroSequence = ({ onReveal, onComplete }) => {
            const [shouldPlay, setShouldPlay] = useState(() => {
                const hasPlayed = sessionStorage.getItem('animesmerens_intro_v1');
                return !hasPlayed;
            });

            const [scope, animate] = useAnimate();
            const counterRef = useRef(null);
            const kanjiRef = useRef(null);

            useEffect(() => {
                if (!shouldPlay) {
                    if (onReveal) onReveal();
                    if (onComplete) onComplete();
                    return;
                }

                sessionStorage.setItem('animesmerens_intro_v1', 'true');

                const runSequence = async () => {
                    // PHASE 1: COLD BOOT
                    let count = 0;
                    const counterInterval = setInterval(() => {
                        count += Math.floor(Math.random() * 5) + 1;
                        if (count > 100) count = 100;
                        if (counterRef.current) counterRef.current.textContent = `${count.toString().padStart(3, '0')}%`;
                        if (count === 100) clearInterval(counterInterval);
                    }, 30); 

                    const kanjiInterval = setInterval(() => {
                        if (kanjiRef.current) {
                            kanjiRef.current.textContent = KANJI_CHARS[Math.floor(Math.random() * KANJI_CHARS.length)];
                        }
                    }, 100);

                    await new Promise(r => setTimeout(r, 2000));
                    clearInterval(kanjiInterval);
                    
                    await animate([
                        [kanjiRef.current, { opacity: 0 }, { duration: 0.2 }],
                        [counterRef.current, { opacity: 0 }, { duration: 0.2, at: "<" }]
                    ]);

                    // PHASE 2: KINETIC TYPO
                    await animate("#text-container", { opacity: 1 }, { duration: 0 });

                    await animate([
                        ["#text-top", { x: '0%' }, { duration: 1.2, ease: [0.22, 1, 0.36, 1] }],
                        ["#text-bottom", { x: '0%' }, { duration: 1.2, ease: [0.22, 1, 0.36, 1], at: "<" }]
                    ]);

                    await animate([
                        ["#text-top", { scaleY: 1.5 }, { duration: 0.1, at: "+0.1" }],
                        ["#text-bottom", { scaleY: 1.5 }, { duration: 0.1, at: "<" }]
                    ]);
                    
                    await animate([
                        ["#text-top", { scaleY: 1 }, { duration: 0.2 }],
                        ["#text-bottom", { scaleY: 1 }, { duration: 0.2, at: "<" }]
                    ]);

                    // PHASE 3: REVEAL
                    await animate([
                        ["#text-top", { color: "transparent", WebkitTextStroke: "2px white" }, { duration: 0.2 }],
                        ["#text-bottom", { color: "transparent", WebkitTextStroke: "2px white" }, { duration: 0.2, at: "<" }]
                    ]);

                    if (onReveal) onReveal();

                    await Promise.all([
                        animate(".shutter-slice", { height: "0%" }, { delay: stagger(0.1), duration: 1.2, ease: "easeInOut" }),
                        animate("#text-container", { scale: 1.1, opacity: 0 }, { duration: 1, ease: "easeIn" }),
                        animate(scope.current, { opacity: 0 }, { duration: 1, delay: 0.5 }) 
                    ]);

                    if (scope.current) scope.current.style.display = 'none';
                    if (onComplete) onComplete();
                };

                runSequence();
            }, [shouldPlay]);

            if (!shouldPlay) return null;

            return (
                <div ref={scope} className="fixed inset-0 z-[9999] flex items-center justify-center pointer-events-none bg-black">
                    <div className="absolute inset-0 flex h-full w-full pointer-events-auto">
                        {[...Array(5)].map((_, i) => (
                            <div key={i} className="shutter-slice h-full w-1/5 bg-[#050505] border-r border-white/5 origin-top"></div>
                        ))}
                    </div>
                    <div className="relative z-10 w-full h-full flex items-center justify-center overflow-hidden">
                        <div ref={kanjiRef} className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 font-oswald text-yellow-400 text-6xl font-bold opacity-100"></div>
                        <div className="absolute bottom-10 right-10 overflow-hidden">
                             <div ref={counterRef} className="font-grotesk font-bold text-4xl text-white tracking-widest">000%</div>
                        </div>
                        <div id="text-container" className="opacity-0 flex flex-col items-center justify-center mix-blend-difference w-full">
                            <div className="overflow-hidden py-10 -my-10 w-full flex justify-center">
                                <h1 id="text-top" className="font-oswald text-[15vw] leading-[0.9] font-bold text-white tracking-tighter translate-x-[-100%] origin-bottom">
                                    ANIME
                                </h1>
                            </div>
                            <div className="overflow-hidden py-10 -my-10 w-full flex justify-center">
                                <h1 id="text-bottom" className="font-oswald text-[15vw] leading-[0.9] font-bold text-white tracking-tighter translate-x-[100%] origin-top">
                                    SMERENS
                                </h1>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // 2. SEARCH OVERLAY
        const SearchOverlay = ({ isOpen, onClose, onSelect }) => {
            const [query, setQuery] = useState("");
            const [activeGenre, setActiveGenre] = useState(null);
            const [results, setResults] = useState([]);
            const [loading, setLoading] = useState(false);
            const inputRef = useRef(null);
            const abortControllerRef = useRef(null);

            useEffect(() => {
                if (isOpen && inputRef.current) setTimeout(() => inputRef.current.focus(), 100);
            }, [isOpen]);

            useEffect(() => {
                if (abortControllerRef.current) abortControllerRef.current.abort();
                abortControllerRef.current = new AbortController();
                const signal = abortControllerRef.current.signal;

                const delayDebounceFn = setTimeout(async () => {
                    if (query.trim().length > 2 || activeGenre) {
                        setLoading(true);
                        try {
                            let endpoint = `https://kitsu.io/api/edge/anime?page[limit]=10`;
                            if (query.trim().length > 0) endpoint += `&filter[text]=${encodeURIComponent(query)}`;
                            else if (activeGenre) endpoint += `&filter[categories]=${encodeURIComponent(activeGenre)}`;

                            const res = await fetch(endpoint, { signal });
                            const json = await res.json();
                            
                            if (!signal.aborted && json.data) {
                                setResults(json.data.map(item => ({
                                    id: item.id,
                                    title: item.attributes.canonicalTitle,
                                    image: item.attributes.posterImage?.small,
                                    year: item.attributes.startDate ? item.attributes.startDate.substring(0, 4) : 'TBA',
                                    score: item.attributes.averageRating ? Math.round(item.attributes.averageRating) : null,
                                    rank: item.attributes.ratingRank || item.attributes.popularityRank || "--",
                                    attributes: item.attributes
                                })));
                            }
                        } catch (e) {
                            if (e.name !== 'AbortError') console.error(e);
                        } finally {
                            if (!signal.aborted) setLoading(false);
                        }
                    } else {
                        setResults([]);
                        setLoading(false);
                    }
                }, 300);

                return () => clearTimeout(delayDebounceFn);
            }, [query, activeGenre]);

            return (
                <AnimatePresence>
                    {isOpen && (
                        <motion.div
                            initial={{ opacity: 0 }}
                            animate={{ opacity: 1 }}
                            exit={{ opacity: 0 }}
                            className="fixed inset-0 z-[100] bg-black/95 backdrop-blur-md overflow-y-auto overflow-x-hidden"
                        >
                            <div className="flex flex-col items-center min-h-screen pt-24 px-4 pb-20 w-full relative">
                                <button onClick={onClose} className="fixed top-6 right-6 z-[101] p-3 rounded-full bg-white/10 hover:bg-white/20 transition text-white border border-white/10">
                                    <X size={20} />
                                </button>

                                <motion.div initial={{ y: 20, opacity: 0 }} animate={{ y: 0, opacity: 1 }} className="w-full max-w-4xl relative shrink-0">
                                    <input
                                        ref={inputRef}
                                        placeholder="SEARCH ARCHIVES..."
                                        value={query}
                                        onChange={(e) => { setActiveGenre(null); setQuery(e.target.value); }}
                                        className="w-full bg-transparent border-b-2 border-white/20 py-4 md:py-8 text-center font-oswald text-3xl md:text-7xl font-bold uppercase text-white placeholder-white/10 outline-none focus:border-[var(--accent)] transition-colors"
                                    />
                                </motion.div>

                                <motion.div initial={{ y: 20, opacity: 0 }} animate={{ y: 0, opacity: 1 }} transition={{ delay: 0.1 }} className="mt-6 md:mt-8 w-full max-w-4xl">
                                    <div className="flex flex-wrap gap-2 md:gap-3 justify-center">
                                        {GENRES.map((genre) => (
                                            <button
                                                key={genre}
                                                onClick={() => { setQuery(""); setActiveGenre(genre === activeGenre ? null : genre); }}
                                                className={`px-4 py-2 md:px-6 md:py-2 rounded-full border text-[10px] md:text-xs font-bold uppercase tracking-widest transition-all duration-300 ${activeGenre === genre ? 'bg-[var(--accent)] text-black border-[var(--accent)] scale-105' : 'bg-transparent text-white/50 border-white/10 hover:border-white/40 hover:text-white'}`}
                                            >
                                                {genre}
                                            </button>
                                        ))}
                                    </div>
                                </motion.div>

                                <div className="mt-8 md:mt-12 w-full max-w-6xl grid grid-cols-2 md:grid-cols-5 gap-4 md:gap-6">
                                    {loading ? [...Array(10)].map((_, i) => <div key={i} className="aspect-[2/3] rounded-xl bg-white/5 animate-pulse border border-white/5" />) : (
                                        results.map((anime, i) => (
                                            <motion.div
                                                key={anime.id}
                                                initial={{ opacity: 0, y: 10 }}
                                                animate={{ opacity: 1, y: 0 }}
                                                transition={{ duration: 0.2, delay: i * 0.03 }}
                                                className="group relative cursor-pointer"
                                                onClick={() => onSelect(anime)}
                                            >
                                                <div className="aspect-[2/3] overflow-hidden rounded-xl bg-white/5 mb-4 border border-white/10 group-hover:border-[var(--accent)] transition-colors">
                                                    <img src={anime.image} alt={anime.title} className="h-full w-full object-cover transition-transform duration-500 group-hover:scale-110 grayscale group-hover:grayscale-0" />
                                                </div>
                                                {anime.score && <div className="absolute top-2 right-2 px-2 py-1 bg-black/80 backdrop-blur-sm rounded border border-white/10 flex items-center gap-1 z-10"><Star size={8} className="text-[var(--accent)] fill-[var(--accent)]" /><span className="text-[10px] font-bold font-oswald text-white">{anime.score}</span></div>}
                                                <h4 className="font-oswald text-sm md:text-lg leading-tight text-white group-hover:text-[var(--accent)] transition-colors line-clamp-1">{anime.title}</h4>
                                                <p className="font-grotesk text-[10px] md:text-xs text-white/40 mt-1">{anime.year}</p>
                                            </motion.div>
                                        ))
                                    )}
                                </div>
                            </div>
                        </motion.div>
                    )}
                </AnimatePresence>
            );
        };

        // 3. SUB COMPONENTS
        const Counter = ({ value }) => {
            const ref = useRef(null);
            const motionValue = useMotionValue(0);
            const springValue = useSpring(motionValue, { damping: 50, stiffness: 100 });
            const isInView = useInView(ref, { once: true, margin: "-100px" });

            useEffect(() => { if (isInView) motionValue.set(value); }, [isInView, value]);
            useEffect(() => springValue.on("change", (latest) => { if (ref.current) ref.current.textContent = Number.isInteger(value) ? Math.floor(latest).toFixed(0) : latest.toFixed(1); }), [springValue, value]);
            return <span ref={ref} />;
        };

        const DonutChart = ({ score, color }) => {
            const radius = 40;
            const circumference = 2 * Math.PI * radius;
            const fillPercent = (score / 10) * circumference;
            return (
                <div className="relative w-24 h-24 flex items-center justify-center">
                    <svg className="w-full h-full -rotate-90" viewBox="0 0 100 100">
                        <circle cx="50" cy="50" r={radius} stroke="#333" strokeWidth="8" fill="transparent" />
                        <motion.circle cx="50" cy="50" r={radius} stroke={color} strokeWidth="8" fill="transparent" strokeDasharray={circumference} initial={{ strokeDashoffset: circumference }} whileInView={{ strokeDashoffset: circumference - fillPercent }} viewport={{ once: true }} transition={{ duration: 1.5, ease: "easeOut" }} strokeLinecap="round" />
                    </svg>
                    <div className="absolute inset-0 flex items-center justify-center font-oswald text-2xl font-bold text-white"><Counter value={score} /></div>
                </div>
            );
        };

        const BentoCard = ({ title, value, sub, icon: Icon, delay = 0, isScore = false, color, isStudio = false }) => {
            return (
                <motion.div
                    initial={{ opacity: 0, y: 50 }}
                    whileInView={{ opacity: 1, y: 0 }}
                    viewport={{ once: true, margin: "-50px" }}
                    transition={{ duration: 0.8, delay, ease: [0.22, 1, 0.36, 1] }}
                    className={`group relative overflow-hidden rounded-3xl p-6 backdrop-blur-md transition-colors ${isStudio ? 'accent-bg text-black' : 'border border-white/10 bg-white/5 hover:bg-white/10'}`}
                    style={!isStudio ? { borderColor: 'rgba(255,255,255,0.1)' } : {}}
                >
                    <div className="absolute -right-4 -top-4 opacity-10 transition-transform duration-500 group-hover:scale-110 group-hover:rotate-12">{Icon && <Icon size={120} />}</div>
                    <div className="relative z-10 flex h-full flex-col justify-between">
                        <h3 className={`font-grotesk text-sm uppercase tracking-widest ${isStudio ? 'text-black/60 font-bold' : 'text-white/50'}`}>{title}</h3>
                        {isScore ? (
                            <div className="mt-4 flex items-end gap-4"><DonutChart score={Number(value)} color={color} /><div className="mb-2"><span className="block text-xs text-white/40">MASTERPIECE</span><span className="block text-xs accent-text">CRITICAL ACCLAIM</span></div></div>
                        ) : isStudio ? (
                            <div className="mt-4"><ArrowUpRight className="absolute top-6 right-6 transition-transform group-hover:rotate-45" size={32}/><div className="font-oswald text-3xl font-bold uppercase leading-none break-words">{value}</div></div>
                        ) : (
                            <div className="mt-4"><div className="font-oswald text-5xl font-bold text-white tracking-tight flex items-baseline gap-1">
                                {typeof value === 'string' && value.includes('#') && <span className="text-2xl align-top text-[var(--accent)]">#</span>}
                                {(() => {
                                    const numeric = typeof value === 'string' ? parseFloat(value.replace(/[^0-9.]/g, '')) : value;
                                    if (isNaN(numeric)) return <span>{typeof value === 'string' ? value.replace('#', '') : value}</span>;
                                    return <Counter value={numeric} />;
                                })()}
                                {typeof value === 'string' && value.includes('M') && <span className="text-3xl">M</span>}
                                {typeof value === 'string' && value.includes('K') && <span className="text-3xl">K</span>}
                            </div>
                            {sub && <p className="mt-1 font-grotesk text-xs text-white/60">{sub}</p>}</div>
                        )}
                    </div>
                </motion.div>
            );
        };

        const DecryptText = ({ text }) => {
            const cleanText = text ? text.replace(/<[^>]*>/g, '') : "Loading data...";
            return (
                <motion.p 
                    initial="hidden" whileInView="visible" viewport={{ once: true, margin: "-10%" }}
                    variants={{ hidden: { opacity: 0 }, visible: { opacity: 1, transition: { staggerChildren: 0.005, delayChildren: 0.1 } } }}
                    className="font-grotesk text-lg leading-relaxed text-white/90 md:text-xl lg:text-2xl"
                >
                    {cleanText.split(" ").map((word, i) => (
                        <motion.span key={i} variants={{ hidden: { opacity: 0, filter: "blur(8px)", y: 10 }, visible: { opacity: 1, filter: "blur(0px)", y: 0, transition: { duration: 0.5, ease: "easeOut" } } }} className="inline-block mr-1.5">{word}</motion.span>
                    ))}
                </motion.p>
            );
        };

        // API Helper
        const fetchAnimeDetails = async (title, image) => {
            try {
                const kitsuReq = fetch(`https://kitsu.io/api/edge/anime?filter[text]=${encodeURIComponent(title)}`).then(r => r.json());
                const anilistQuery = `query ($search: String) { Media (search: $search, type: ANIME) { genres studios(isMain: true) { nodes { name } } characters(sort: ROLE, perPage: 12) { edges { node { name { full }, image { large } }, role } } externalLinks { site url } } }`;
                const anilistReq = fetch('https://graphql.anilist.co', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' }, body: JSON.stringify({ query: anilistQuery, variables: { search: title } }) }).then(r => r.json());

                const [kitsuRes, anilistRes] = await Promise.all([kitsuReq, anilistReq]);

                if (kitsuRes.data && kitsuRes.data.length > 0 && anilistRes.data && anilistRes.data.Media) {
                    const kAttr = kitsuRes.data[0].attributes;
                    const aMedia = anilistRes.data.Media;
                    const displayTitle = kAttr.canonicalTitle || kAttr.titles.en || kAttr.titles.en_jp;
                    
                    const links = aMedia.externalLinks || [];
                    const officialSites = ['Crunchyroll', 'Netflix', 'Hulu', 'Amazon Prime Video'];
                    const streamingLink = links.find(link => officialSites.includes(link.site)) || links.find(link => link.site === "Official Site") || links[0];
                    const finalStreamingUrl = streamingLink ? streamingLink.url : `https://www.crunchyroll.com/search?q=${encodeURIComponent(displayTitle)}`;
                    const rankValue = kAttr.ratingRank || kAttr.popularityRank || "--";

                    return {
                        title: displayTitle.toUpperCase(), 
                        japanese: kAttr.titles.ja_jp || kAttr.titles.en_jp,
                        score: kAttr.averageRating ? (parseFloat(kAttr.averageRating) / 10).toFixed(1) : "0.0", 
                        rank: `#${rankValue}`, 
                        popularity: kAttr.userCount ? `${(kAttr.userCount / 1000).toFixed(1)}K` : "0K",
                        episodes: kAttr.episodeCount || '?',
                        synopsis: kAttr.synopsis || "No synopsis available.",
                        coverImage: kAttr.coverImage?.original || kAttr.coverImage?.large || kAttr.posterImage?.original || image,
                        tags: aMedia.genres ? aMedia.genres.slice(0, 3) : ['Action'],
                        studio: aMedia.studios?.nodes?.[0]?.name || "Unknown Studio",
                        characters: aMedia.characters?.edges || [],
                        streamingUrl: finalStreamingUrl
                    };
                }
            } catch (error) { console.error("Data load failed", error); }
            return null;
        };

        // --- MAIN APP ---
        const App = () => {
            const { scrollY } = useScroll();
            const [appVisible, setAppVisible] = useState(false);
            const [searchOpen, setSearchOpen] = useState(false);
            const [slideIndex, setSlideIndex] = useState(0);
            const [slidesData, setSlidesData] = useState({});
            const [manualSelection, setManualSelection] = useState(null);
            const [manualData, setManualData] = useState(null);
            const [isShuffling, setIsShuffling] = useState(false);
            const [shufflePreview, setShufflePreview] = useState(null);

            const currentSlide = HERO_SLIDES[slideIndex];

            // Auto-Rotate
            useEffect(() => {
                const timer = setInterval(() => {
                    const isHeroVisible = window.scrollY < (window.innerHeight * 0.5);
                    if (isHeroVisible && !searchOpen && !manualSelection && !isShuffling) { 
                        setSlideIndex((prev) => (prev + 1) % HERO_SLIDES.length);
                    }
                }, 8000); 
                return () => clearInterval(timer);
            }, [slideIndex, searchOpen, manualSelection, isShuffling]);

            // Preload
            useEffect(() => {
                const fetchAllSlides = async () => {
                    const results = await Promise.all(HERO_SLIDES.map(slide => fetchAnimeDetails(slide.query, slide.image)));
                    const dataMap = {};
                    results.forEach((data, i) => { if (data) dataMap[HERO_SLIDES[i].id] = data; });
                    setSlidesData(dataMap);
                };
                fetchAllSlides();
            }, []);

            const handleSearchSelect = async (anime) => {
                setSearchOpen(false);
                setManualSelection(anime); 
                setManualData(null); 
                window.scrollTo({ top: 0, behavior: 'smooth' });
                const details = await fetchAnimeDetails(anime.title, anime.image);
                setManualData(details);
            };

            const handleShuffle = async () => {
                if (isShuffling) return;
                setIsShuffling(true);
                setManualSelection({ id: 'shuffling', title: 'ACCESSING MAINFRAME...', image: null }); 
                setManualData(null);
                window.scrollTo({ top: 0, behavior: 'smooth' });
                setShufflePreview({ title: "INITIALIZING", japanese: "検索中...", coverImage: null, tags: ["SCANNING", "DATABASE", "RANDOM"] });

                try {
                    const randomOffset = Math.floor(Math.random() * 2000);
                    const res = await fetch(`https://kitsu.io/api/edge/anime?sort=-user_count&page[limit]=1&page[offset]=${randomOffset}`);
                    const json = await res.json();
                    
                    if (json.data && json.data.length > 0) {
                        const anime = json.data[0];
                        const title = anime.attributes.canonicalTitle;
                        const image = anime.attributes.posterImage?.original || anime.attributes.coverImage?.original;
                        const details = await fetchAnimeDetails(title, image);
                        
                        const img = new Image();
                        img.src = image;
                        img.onload = () => {
                            setTimeout(() => {
                                setManualSelection({ id: anime.id, title, image });
                                setManualData(details);
                                setIsShuffling(false);
                                setShufflePreview(null);
                            }, 500);
                        };
                    } else throw new Error("No data");
                } catch (e) { setIsShuffling(false); setManualSelection(null); }
            };

            const activeData = isShuffling ? shufflePreview : (manualSelection ? manualData : slidesData[currentSlide.id]);
            const isLoading = !activeData && (manualSelection || (!slidesData[currentSlide.id] && !isShuffling));
            const activeId = manualSelection ? manualSelection.id : currentSlide.id;
            const activeImage = isShuffling ? null : (activeData?.coverImage || (manualSelection ? manualSelection.image : currentSlide.image));
            const titleText = activeData?.title || (manualSelection ? manualSelection.title : "INITIALIZING");
            const getFontSize = (text) => text.length > 25 ? "text-[6vw] md:text-[7vw]" : text.length > 15 ? "text-[8vw] md:text-[10vw]" : "text-[10vw] md:text-[12vw]";

            // Motion Values
            const yTitle = useTransform(scrollY, [0, 500], [0, 200]);
            const scaleTitle = useTransform(scrollY, [0, 400], [1, 0.6]); 
            const opacityHero = useTransform(scrollY, [0, 600], [1, 0]);
            const scaleHero = useTransform(scrollY, [0, 600], [1, 1.1]);
            const fillOpacity = useTransform(scrollY, [0, 300], [0, 1]);
            const strokeOpacity = useTransform(scrollY, [0, 300], [1, 0]);
            const x = useMotionValue(0);
            const y = useMotionValue(0);
            const rotateX = useTransform(y, [-500, 500], [5, -5]);
            const rotateY = useTransform(x, [-500, 500], [-5, 5]);

            return (
                <div 
                    className="min-h-screen bg-[#050505] text-white overflow-x-hidden transition-colors duration-1000" 
                    onMouseMove={(e) => { x.set(e.clientX - window.innerWidth/2); y.set(e.clientY - window.innerHeight/2); }}
                    style={{ '--accent': manualSelection ? '#facc15' : currentSlide.color }}
                >
                    <IntroSequence onReveal={() => setAppVisible(true)} onComplete={() => setAppVisible(true)} />
                    <SearchOverlay isOpen={searchOpen} onClose={() => setSearchOpen(false)} onSelect={handleSearchSelect} />

                    <motion.div initial={{ opacity: 0 }} animate={{ opacity: appVisible ? 1 : 0 }} transition={{ duration: 1.5, ease: "easeOut" }} style={{ width: '100%' }}>
                        <motion.nav style={{ opacity: fillOpacity }} className="fixed top-0 left-0 z-50 w-full border-b border-white/10 bg-black/80 backdrop-blur-md px-6 py-4 flex justify-between items-center">
                            <span className="font-oswald text-xl font-bold tracking-tighter accent-text">ANIMESMERENS</span>
                            <div className="flex gap-4">
                                <button onClick={() => setSearchOpen(true)} className="rounded-full bg-white/10 p-2 hover:bg-white/20 transition group"><Search size={18} className="text-white group-hover:text-[var(--accent)] transition-colors"/></button>
                                <button onClick={() => activeData?.streamingUrl && window.open(activeData.streamingUrl, '_blank')} className="rounded-full accent-bg px-6 py-2 font-oswald text-black font-bold uppercase tracking-wider transition hover:brightness-110 flex items-center gap-2">Watch Now <Play size={16} fill="black" /></button>
                            </div>
                        </motion.nav>

                        <section className="relative h-screen w-full overflow-hidden flex items-center justify-center perspective-1000">
                            <div className="absolute inset-0 z-0 bg-black">
                                <AnimatePresence initial={false} mode="popLayout">
                                    {!isShuffling && (
                                        <motion.div key={activeId} className="absolute inset-0 h-full w-full" initial={{ opacity: 0, scale: 1.15 }} animate={{ opacity: 1, scale: 1 }} exit={{ opacity: 0, scale: 0.95 }} transition={{ duration: 1.2, ease: [0.165, 0.84, 0.44, 1] }}>
                                            <motion.div style={{ rotateX, rotateY, scale: scaleHero, opacity: opacityHero }} className="h-full w-full">
                                                <div className="absolute inset-0 bg-gradient-to-t from-[#050505] via-[#050505]/40 to-transparent z-10" />
                                                <div className="absolute inset-0 bg-black/30 z-10" />
                                                {activeImage && <img src={activeImage} alt={activeId} className="h-full w-full object-cover object-center" />}
                                            </motion.div>
                                        </motion.div>
                                    )}
                                </AnimatePresence>
                            </div>

                            <div className="relative z-20 flex flex-col items-center justify-center w-full px-4 text-center">
                                <div className="relative w-full flex justify-center">
                                    <AnimatePresence mode="wait">
                                        <motion.div key={isShuffling ? 'shuffling-text' : activeId} initial={{ y: 50, opacity: 0 }} animate={{ y: 0, opacity: 1 }} exit={{ y: -50, opacity: 0 }} transition={{ duration: 0.5 }} className="relative w-full max-w-[95vw] flex justify-center">
                                            <motion.h1 style={{ y: yTitle, scale: scaleTitle, opacity: strokeOpacity }} className={`font-oswald ${getFontSize(titleText)} py-4 leading-[0.9] font-bold text-stroke tracking-tighter uppercase text-center break-words`}>{titleText}</motion.h1>
                                            <motion.h1 style={{ y: yTitle, scale: scaleTitle, opacity: fillOpacity, position: 'absolute', top: 0, left: 0, right: 0, color: '#fff' }} className={`font-oswald ${getFontSize(titleText)} py-4 leading-[0.9] font-bold tracking-tighter uppercase text-center break-words pointer-events-none`}>{titleText}</motion.h1>
                                        </motion.div>
                                    </AnimatePresence>
                                </div>

                                <motion.div style={{ opacity: opacityHero, y: yTitle }} className="mt-8 flex flex-col items-center gap-4">
                                    <div className="flex flex-wrap justify-center gap-2">
                                        {(activeData?.tags || []).map((tag, i) => <span key={i} className="border border-white/20 bg-white/5 px-3 py-1 text-xs font-grotesk uppercase tracking-widest backdrop-blur-sm">{tag}</span>)}
                                        {isLoading && <span className="text-xs font-grotesk animate-pulse accent-text">{isShuffling ? "RANDOMIZING SELECTION..." : "LOADING ASSETS..."}</span>}
                                    </div>
                                    <AnimatePresence mode="wait">
                                        <motion.p key={activeId} initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }} className="font-grotesk text-white/60 tracking-widest text-sm">{activeData?.japanese}</motion.p>
                                    </AnimatePresence>
                                </motion.div>
                            </div>

                            <div className="absolute bottom-10 right-10 z-30 flex items-center gap-6">
                                <button onClick={handleShuffle} disabled={isShuffling} className={`group rounded-full border border-white/10 bg-black/20 p-2 backdrop-blur-sm transition-all ${isShuffling ? 'opacity-50 cursor-not-allowed border-[var(--accent)] animate-spin' : 'hover:bg-white/10 hover:border-[var(--accent)]'}`} title="Random Anime"><Shuffle size={16} className={`text-white/70 transition-colors ${!isShuffling && 'group-hover:text-white'}`} /></button>
                                {manualSelection && <button onClick={() => { setManualSelection(null); setManualData(null); }} className="flex items-center gap-2 px-4 py-2 rounded-full border border-white/10 bg-red-500/20 text-white hover:bg-red-500/40 backdrop-blur-md transition-colors mr-4"><X size={16} /> <span className="text-xs font-bold uppercase tracking-widest">Close Entry</span></button>}
                                {!manualSelection && !isShuffling && (
                                    <div className="flex gap-2 items-center">
                                        {HERO_SLIDES.map((_, idx) => <div key={idx} onClick={() => setSlideIndex(idx)} className={`h-1 cursor-pointer transition-all duration-500 ${idx === slideIndex ? 'w-8 accent-bg' : 'w-4 bg-white/30 hover:bg-white'}`} />)}
                                        <button onClick={() => setSlideIndex((p) => (p - 1 + HERO_SLIDES.length) % HERO_SLIDES.length)} className="group rounded-full border border-white/10 bg-black/20 p-2 backdrop-blur-sm transition-all hover:bg-white/10 hover:border-[var(--accent)] ml-4"><ChevronLeft size={16} className="text-white/70 transition-colors group-hover:text-white" /></button>
                                        <button onClick={() => setSlideIndex((p) => (p + 1) % HERO_SLIDES.length)} className="group rounded-full border border-white/10 bg-black/20 p-2 backdrop-blur-sm transition-all hover:bg-white/10 hover:border-[var(--accent)]"><ChevronRight size={16} className="text-white/70 transition-colors group-hover:text-white" /></button>
                                    </div>
                                )}
                            </div>
                        </section>

                        <main className="relative z-30 mx-auto max-w-7xl px-4 sm:px-6 pb-32">
                            <section className="py-24 grid grid-cols-1 lg:grid-cols-12 gap-12 border-b border-white/10 items-start">
                                <div className="lg:col-span-4 sticky top-24">
                                    <motion.div key={activeId} initial={{ opacity: 0, x: -20 }} whileInView={{ opacity: 1, x: 0 }} viewport={{ once: true }} transition={{ duration: 0.6 }}>
                                        <span className="block font-oswald accent-text text-sm tracking-widest mb-4">/// SYSTEM LOG: SYNOPSIS</span>
                                        <h2 className="font-oswald text-4xl uppercase font-bold leading-tight">{(activeData?.title || "ARCHIVE").split(":")[0]} <br/><span className="text-stroke-thin text-white">Archives</span></h2>
                                    </motion.div>
                                </div>
                                <div className="lg:col-span-8 min-h-[200px]">
                                    {isLoading ? <div className="h-full w-full animate-pulse bg-white/5 rounded-xl" /> : <div key={activeId}><DecryptText text={activeData?.synopsis || "Accessing database..."} /></div>}
                                </div>
                            </section>

                            <section className="py-24">
                                <div className="flex items-end justify-between mb-12">
                                    <h2 className="font-oswald text-5xl uppercase font-bold">Performance <span className="accent-text">Metrics</span></h2>
                                    <div className="hidden md:flex gap-2 text-xs font-grotesk text-white/40 uppercase tracking-widest"><span>Live Data</span><span className="animate-pulse text-green-500">●</span></div>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 h-auto md:h-[400px]">
                                    <div className="md:col-span-2 md:row-span-2 h-full"><BentoCard title="Global Score" value={activeData?.score || 0} isScore={true} icon={Star} color={manualSelection ? '#facc15' : currentSlide.color} /></div>
                                    <BentoCard title="Rank" value={activeData?.rank || "#--"} sub="All Time" icon={TrendingUp} delay={0.1} color={manualSelection ? '#facc15' : currentSlide.color} />
                                    <BentoCard title="Popularity" value={activeData?.popularity || "0K"} sub="Active Trackers" icon={Users} delay={0.2} color={manualSelection ? '#facc15' : currentSlide.color} />
                                    <BentoCard title="Episodes" value={activeData?.episodes || 0} sub="24min / ep" icon={Clock} delay={0.3} color={manualSelection ? '#facc15' : currentSlide.color} />
                                    <BentoCard title="Studio" value={activeData?.studio || "Loading..."} isStudio={true} icon={ArrowUpRight} delay={0.4} color={manualSelection ? '#facc15' : currentSlide.color} />
                                </div>
                            </section>

                            <section className="py-24 overflow-hidden">
                                <div className="mb-12 px-2"><h2 className="font-oswald text-4xl uppercase font-bold text-center md:text-left">Key <span className="text-stroke-thin text-white">Personnel</span></h2></div>
                                <div className="relative w-full overflow-hidden mask-linear-gradient">
                                    <div className="absolute left-0 top-0 z-10 h-full w-24 bg-gradient-to-r from-[#050505] to-transparent" />
                                    <div className="absolute right-0 top-0 z-10 h-full w-24 bg-gradient-to-l from-[#050505] to-transparent" />
                                    <div className="flex gap-6 w-max hover:pause-animation">
                                        {activeData?.characters && [...activeData.characters, ...activeData.characters].map((edge, idx) => (
                                            <motion.div key={`${edge.node.name.full}-${idx}`} className="relative flex-shrink-0 w-[200px] aspect-[2/3] group cursor-pointer" whileHover={{ scale: 1.05, zIndex: 10 }} animate={{ x: ["0%", "-100%"] }} transition={{ ease: "linear", duration: 30, repeat: Infinity }}>
                                                <div className="absolute inset-0 rounded-xl overflow-hidden bg-white/5 border border-white/5 group-hover:border-[var(--accent)] transition-colors">
                                                    <img src={edge.node.image.large} alt={edge.node.name.full} className="h-full w-full object-cover transition-all duration-500 group-hover:scale-110 grayscale group-hover:grayscale-0" />
                                                    <div className="absolute inset-0 bg-gradient-to-t from-black/90 via-transparent to-transparent opacity-80" />
                                                    <div className="absolute bottom-0 left-0 p-4 w-full">
                                                        <h4 className="font-oswald text-lg uppercase font-bold text-white transition-colors accent-text-hover truncate">{edge.node.name.full}</h4>
                                                        <p className="font-grotesk text-xs text-white/60">{edge.role}</p>
                                                    </div>
                                                </div>
                                            </motion.div>
                                        ))}
                                        {(!activeData?.characters || activeData.characters.length === 0) && <div className="w-full text-center text-white/30 font-grotesk">Scanning Personnel Database...</div>}
                                    </div>
                                </div>
                                <div className="mt-4 flex justify-center text-xs text-white/30 font-grotesk tracking-widest">/// DRAG TO EXPLORE</div>
                            </section>
                        </main>

                        <footer className="border-t border-white/10 bg-black py-12 text-center">
                            <h2 className="font-oswald text-[15vw] leading-none text-white/5 uppercase select-none pointer-events-none transition-all duration-1000">{(activeData?.title || "ANIMESMERENS").split(" ")[0]}</h2>
                            <div className="font-grotesk text-sm text-white/40 mt-[-5vw] relative z-10">© 2026 ANIMESMERENS PROJECT.</div>
                        </footer>
                    </motion.div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
