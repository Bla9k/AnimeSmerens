<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AnimeSmerens | Archive</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Babel Standalone -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;700&family=Space+Grotesk:wght@300;400;500;600&display=swap" rel="stylesheet">

    <!-- Styles -->
    <style>
        :root {
            --accent: #facc15;
            --bg-color: #050505;
        }
        body {
            background-color: var(--bg-color);
            color: white;
            margin: 0;
            overflow-x: hidden;
            font-family: 'Space Grotesk', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        .font-oswald { font-family: 'Oswald', sans-serif; }
        .font-grotesk { font-family: 'Space Grotesk', sans-serif; }

        ::-webkit-scrollbar { display: none; }
        * { -ms-overflow-style: none; scrollbar-width: none; }

        .gpu-accelerated {
            transform: translate3d(0, 0, 0);
            backface-visibility: hidden;
            perspective: 1000px;
            will-change: transform, opacity;
        }

        .no-flicker {
            -webkit-backface-visibility: hidden;
            -moz-backface-visibility: hidden;
            -webkit-transform: translate3d(0, 0, 0);
            -moz-transform: translate3d(0, 0, 0);
        }

        .text-stroke { -webkit-text-stroke: 2px rgba(255, 255, 255, 0.5); color: transparent; }
        .text-stroke-thin { -webkit-text-stroke: 1px rgba(255, 255, 255, 0.3); color: transparent; }

        @keyframes scroll { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }
        .animate-marquee { animation: scroll 40s linear infinite; }
        .animate-marquee:hover { animation-play-state: paused; }

        .accent-text { color: var(--accent); transition: color 0.5s ease; }
        .accent-bg { background-color: var(--accent); transition: background-color 0.5s ease; }
        
        .mask-linear-gradient {
            mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent);
            -webkit-mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent);
        }

        /* Custom Form Elements */
        select option { background-color: #000; color: white; }

        ::selection { background: var(--accent); color: black; }
        button { touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
    </style>

    <!-- Import Map -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "framer-motion": "https://esm.sh/framer-motion@10.16.4?external=react,react-dom",
        "lucide-react": "https://esm.sh/lucide-react@0.292.0?external=react,react-dom"
      }
    }
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useMemo, useCallback } from 'react';
        import ReactDOM from 'react-dom/client';
        import { motion, useScroll, useTransform, useSpring, useInView, useMotionValue, AnimatePresence, useAnimate, stagger } from 'framer-motion';
        import { Star, TrendingUp, Users, Clock, Play, Heart, ArrowUpRight, Search, X, Hash, Shuffle, ChevronLeft, ChevronRight, Monitor, Trash2, List, Grid, User, LogIn, LogOut, Mail, Lock, Key, Plus, Minus, CheckCircle, PauseCircle, PlayCircle, XCircle, BookOpen } from 'lucide-react';
        
        // --- FIREBASE IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword, linkWithCredential, EmailAuthProvider } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, deleteDoc, updateDoc, onSnapshot, getDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL FIREBASE INIT ---
        let auth;
        let db;
        // Use a FIXED app ID to ensure data persists across app updates/reloads/forks
        const pathAppId = 'anime-smerens-v1-stable'; 

        try {
            // Priority: User's provided config to ensure they connect to THEIR project where they have admin access
            const userFirebaseConfig = {
                apiKey: "AIzaSyAbPe1iD_eyOdgeIppbA0eOGL0hooz1Gaw",
                authDomain: "anime-smerens.firebaseapp.com",
                projectId: "anime-smerens",
                storageBucket: "anime-smerens.firebasestorage.app",
                messagingSenderId: "28256743025",
                appId: "1:28256743025:web:8a2cf88ae3c411485675d0",
                measurementId: "G-GFBF7VDW1W"
            };

            // Use environment config if user config is invalid/missing, otherwise prefer user config for custom auth features
            const firebaseConfig = userFirebaseConfig.projectId ? userFirebaseConfig : (typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : userFirebaseConfig);

            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            
            console.log("ðŸ”¥ FIREBASE PROJECT:", app.options.projectId);

            try {
                if (typeof window !== 'undefined') {
                    const analytics = getAnalytics(app);
                }
            } catch (err) {
                console.warn("Analytics failed to load:", err);
            }
        } catch (e) {
            console.error("Firebase Global Init Failed:", e);
        }

        // --- DATA CONSTANTS ---
        const KANJI_CHARS = ["åº", "ç ´", "æ€¥", "å£±", "å¼", "å‚", "é›¶", "ç„¡", "ç©º", "å¹»", "å½±", "éŸ¿"];
        const GENRES = ["Action", "Adventure", "Cyberpunk", "Drama", "Ecchi", "Fantasy", "Horror", "Mecha", "Music", "Mystery", "Psychological", "Romance", "Sci-Fi", "Slice of Life", "Sports", "Supernatural", "Thriller"];
        const STATUS_OPTIONS = ["Watching", "Planning", "Completed", "On Hold", "Dropped"];

        const HERO_SLIDES = [
            { id: 'edgerunners', query: 'Cyberpunk: Edgerunners', color: '#facc15', image: 'https://images.unsplash.com/photo-1555680202-c86f0e12f086?q=80&w=2070&auto=format&fit=crop' },
            { id: 'bleach', query: 'Bleach: Thousand-Year Blood War', color: '#f97316', image: 'https://images.unsplash.com/photo-1578632767115-351597cf2477?q=80&w=2070&auto=format&fit=crop' },
            { id: 'chainsaw', query: 'Chainsaw Man', color: '#14b8a6', image: 'https://images.unsplash.com/photo-1618336753974-aae8e04506aa?q=80&w=2070&auto=format&fit=crop' },
            { id: 'jjk', query: 'Jujutsu Kaisen', color: '#ef4444', image: 'https://images.unsplash.com/photo-1518709268805-4e9042af9f23?q=80&w=2068&auto=format&fit=crop' }
        ];

        // --- COMPONENTS ---
        
        const SmoothHeroImage = ({ src, alt }) => {
            const [isLoaded, setIsLoaded] = useState(false);
            return (
                <motion.img 
                    src={src} 
                    alt={alt} 
                    initial={{ opacity: 0 }}
                    animate={{ opacity: isLoaded ? 1 : 0 }}
                    transition={{ duration: 0.8, ease: "easeOut" }}
                    onLoad={() => setIsLoaded(true)}
                    className="h-full w-full object-cover object-center"
                />
            );
        };

        const IntroSequence = ({ onReveal, onComplete }) => {
            const [shouldPlay, setShouldPlay] = useState(() => !sessionStorage.getItem('animesmerens_intro_v2'));
            const [scope, animate] = useAnimate();
            const counterRef = useRef(null);
            const kanjiRef = useRef(null);

            useEffect(() => {
                if (!shouldPlay) {
                    if (onReveal) onReveal();
                    if (onComplete) onComplete();
                    return;
                }
                sessionStorage.setItem('animesmerens_intro_v2', 'true');

                const runSequence = async () => {
                    let count = 0;
                    const counterInterval = setInterval(() => {
                        count = Math.min(count + Math.floor(Math.random() * 8) + 2, 100);
                        if (counterRef.current) counterRef.current.textContent = `${count.toString().padStart(3, '0')}%`;
                        if (count === 100) clearInterval(counterInterval);
                    }, 30); 

                    const kanjiInterval = setInterval(() => {
                        if (kanjiRef.current) kanjiRef.current.textContent = KANJI_CHARS[Math.floor(Math.random() * KANJI_CHARS.length)];
                    }, 80);

                    await new Promise(r => setTimeout(r, 1800));
                    clearInterval(kanjiInterval);
                    
                    await animate([
                        [kanjiRef.current, { opacity: 0 }, { duration: 0.3 }],
                        [counterRef.current, { opacity: 0 }, { duration: 0.3, at: "<" }]
                    ]);

                    await animate("#text-container", { opacity: 1 }, { duration: 0 });
                    
                    await animate([
                        ["#text-top", { x: '0%' }, { duration: 1.2, ease: [0.22, 1, 0.36, 1] }],
                        ["#text-bottom", { x: '0%' }, { duration: 1.2, ease: [0.22, 1, 0.36, 1], at: "<" }]
                    ]);

                    if (onReveal) onReveal();

                    await Promise.all([
                        animate(".shutter-slice", { height: "0%" }, { delay: stagger(0.05), duration: 0.8, ease: "easeInOut" }),
                        animate("#text-container", { scale: 1.1, opacity: 0 }, { duration: 0.8, ease: "easeIn" }),
                        animate(scope.current, { opacity: 0 }, { duration: 0.8, delay: 0.2 }) 
                    ]);

                    if (scope.current) scope.current.style.display = 'none';
                    if (onComplete) onComplete();
                };
                runSequence();
            }, [shouldPlay]);

            if (!shouldPlay) return null;

            return (
                <div ref={scope} className="fixed inset-0 z-[9999] flex items-center justify-center pointer-events-none bg-black gpu-accelerated">
                    <div className="absolute inset-0 flex h-full w-full pointer-events-auto">
                        {[...Array(5)].map((_, i) => (
                            <div key={i} className="shutter-slice h-full w-1/5 bg-[#050505] border-r border-white/5 origin-top will-change-transform"></div>
                        ))}
                    </div>
                    <div className="relative z-10 w-full h-full flex items-center justify-center overflow-hidden">
                        <div ref={kanjiRef} className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 font-oswald text-yellow-400 text-6xl font-bold opacity-100 will-change-opacity"></div>
                        <div className="absolute bottom-10 right-10 overflow-hidden">
                             <div ref={counterRef} className="font-grotesk font-bold text-4xl text-white tracking-widest will-change-opacity">000%</div>
                        </div>
                        <div id="text-container" className="opacity-0 flex flex-col items-center justify-center w-full z-20 will-change-transform">
                            <div className="overflow-hidden py-10 -my-10 w-full flex justify-center">
                                <h1 id="text-top" className="font-oswald text-[15vw] leading-[0.9] font-bold text-white tracking-tighter translate-x-[-100%] origin-bottom will-change-transform">ANIME</h1>
                            </div>
                            <div className="overflow-hidden py-10 -my-10 w-full flex justify-center">
                                <h1 id="text-bottom" className="font-oswald text-[15vw] leading-[0.9] font-bold text-white tracking-tighter translate-x-[100%] origin-top will-change-transform">SMERENS</h1>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // NEW: Friend Profile Modal (Read Only)
        const FriendProfileModal = ({ isOpen, onClose, targetUid, db, pathAppId }) => {
            const [profile, setProfile] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                if (isOpen && targetUid && db) {
                    setLoading(true);
                    const docRef = doc(db, 'artifacts', pathAppId, 'public', 'data', 'profiles', targetUid);
                    
                    // Real-time listener for the friend's profile
                    const unsubscribe = onSnapshot(docRef, (docSnap) => {
                        if (docSnap.exists()) {
                            setProfile(docSnap.data());
                        } else {
                            // Fallback if public profile doesn't exist yet
                            setProfile(null); 
                        }
                        setLoading(false);
                    });
                    
                    document.body.style.overflow = 'hidden';
                    return () => {
                        unsubscribe();
                        document.body.style.overflow = '';
                    };
                }
            }, [isOpen, targetUid, db, pathAppId]);

            if (!isOpen) return null;

            return (
                <AnimatePresence>
                    <motion.div
                        initial={{ opacity: 0 }}
                        animate={{ opacity: 1 }}
                        exit={{ opacity: 0 }}
                        className="fixed inset-0 z-[300] bg-black/95 backdrop-blur-xl overflow-y-auto no-flicker flex items-center justify-center p-4"
                        onClick={onClose}
                    >
                        <motion.div 
                            initial={{ scale: 0.95, y: 20 }}
                            animate={{ scale: 1, y: 0 }}
                            exit={{ scale: 0.95, y: 20 }}
                            className="relative w-full max-w-2xl bg-[#0a0a0a] border border-white/10 rounded-3xl overflow-hidden shadow-2xl"
                            onClick={e => e.stopPropagation()}
                        >
                            {loading ? (
                                <div className="h-64 flex items-center justify-center text-white/30 font-grotesk animate-pulse">
                                    ACCESSING AGENT DATA...
                                </div>
                            ) : profile ? (
                                <>
                                    {/* Banner */}
                                    <div className="relative h-48 w-full bg-white/5">
                                        <div className="absolute inset-0 bg-gradient-to-t from-[#0a0a0a] to-transparent z-10" />
                                        {profile.banner ? (
                                            <img src={profile.banner} className="w-full h-full object-cover opacity-60" alt="Banner" />
                                        ) : (
                                            <div className="w-full h-full bg-gradient-to-r from-gray-900 to-black" />
                                        )}
                                        <button 
                                            onClick={onClose} 
                                            className="absolute top-4 right-4 z-20 p-2 bg-black/50 backdrop-blur-md rounded-full text-white/70 hover:text-white border border-white/10 hover:border-white/30 transition-all active:scale-95"
                                        >
                                            <X size={20} />
                                        </button>
                                    </div>

                                    {/* Content */}
                                    <div className="relative z-20 px-8 pb-10 -mt-16">
                                        <div className="flex flex-col md:flex-row items-end gap-6 mb-6">
                                            <div className="w-32 h-32 rounded-full border-4 border-[#0a0a0a] bg-black overflow-hidden relative shadow-xl shrink-0">
                                                {profile.avatar ? (
                                                    <img src={profile.avatar} className="w-full h-full object-cover" alt="Avatar" />
                                                ) : (
                                                    <div className="w-full h-full flex items-center justify-center bg-white/10"><User size={48} className="text-white/20" /></div>
                                                )}
                                            </div>
                                            
                                            <div className="mb-2">
                                                <h2 className="font-oswald text-4xl md:text-5xl font-bold text-white uppercase leading-none flex items-center gap-3">
                                                    {profile.displayName}
                                                </h2>
                                                <p className="font-grotesk text-[var(--accent)] text-xs tracking-widest uppercase mt-1">
                                                    /// ID: {profile.agentId || 'UNKNOWN'}
                                                </p>
                                            </div>
                                        </div>

                                        <div className="bg-white/5 border border-white/10 rounded-xl p-6">
                                            <h3 className="font-oswald text-white/40 uppercase text-sm mb-2">Bio_Data</h3>
                                            <p className="font-grotesk text-white/80 leading-relaxed text-sm md:text-base">
                                                {profile.bio || "No biographical data available for this agent."}
                                            </p>
                                        </div>
                                        
                                        <div className="mt-4 text-center">
                                            <span className="text-[10px] font-grotesk text-white/20 uppercase tracking-widest">
                                                READ ONLY MODE // SECURE CONNECTION
                                            </span>
                                        </div>
                                    </div>
                                </>
                            ) : (
                                <div className="p-12 text-center">
                                    <div className="w-16 h-16 bg-white/5 rounded-full flex items-center justify-center mx-auto mb-4">
                                        <User size={32} className="text-white/20" />
                                    </div>
                                    <h3 className="font-oswald text-xl text-white mb-2">Profile Unavailable</h3>
                                    <p className="text-white/40 text-sm">Agent data not found or access restricted.</p>
                                    <button onClick={onClose} className="mt-6 px-6 py-2 border border-white/10 rounded text-white/60 hover:text-white transition">Close</button>
                                </div>
                            )}
                        </motion.div>
                    </motion.div>
                </AnimatePresence>
            );
        };

        // UPDATED: Profile List Manager (Favorites Overlay)
        const FavoritesOverlay = ({ isOpen, onClose, favorites, onSelect, onUpdateEntry, onDeleteEntry }) => {
            const [viewMode, setViewMode] = useState("list"); // Default to list for easier management
            const [editingEpId, setEditingEpId] = useState(null); // Track which anime's episode is being edited via input
            const [tempEpValue, setTempEpValue] = useState("");   // Temporary value for the input

            // Prevent scroll when open
            useEffect(() => {
                if (isOpen) document.body.style.overflow = 'hidden';
                else document.body.style.overflow = '';
                return () => { document.body.style.overflow = ''; };
            }, [isOpen]);

            // Helper to get status icon
            const getStatusIcon = (status) => {
                switch(status) {
                    case 'Watching': return <PlayCircle size={14} className="text-[var(--accent)]" />;
                    case 'Completed': return <CheckCircle size={14} className="text-green-400" />;
                    case 'On Hold': return <PauseCircle size={14} className="text-orange-400" />;
                    case 'Dropped': return <XCircle size={14} className="text-red-400" />;
                    default: return <BookOpen size={14} className="text-blue-400" />; // Planning
                }
            };

            // Helper for status colors in the new UI
            const getStatusColor = (status) => {
                switch(status) {
                    case 'Watching': return 'text-[var(--accent)] border-[var(--accent)] shadow-[0_0_10px_-5px_var(--accent)]';
                    case 'Completed': return 'text-green-400 border-green-400 shadow-[0_0_10px_-5px_rgba(74,222,128,0.5)]';
                    case 'On Hold': return 'text-orange-400 border-orange-400';
                    case 'Dropped': return 'text-red-400 border-red-400';
                    default: return 'text-blue-400 border-blue-400';
                }
            };

            const handleEpInputChange = (e, anime) => {
                const val = e.target.value;
                // Allow empty string or numbers only
                if (val === '' || /^\d+$/.test(val)) {
                    setTempEpValue(val);
                }
            };

            const handleEpInputBlur = (anime) => {
                setEditingEpId(null);
                let newEp = parseInt(tempEpValue);
                if (isNaN(newEp)) newEp = anime.watched || 0;
                
                // Clamp value
                const maxEp = anime.totalEpisodes || 9999;
                newEp = Math.max(0, Math.min(maxEp, newEp));
                
                if (newEp !== anime.watched) {
                    onUpdateEntry(anime.id, { watched: newEp });
                }
            };

            const handleEpInputKeyDown = (e, anime) => {
                if (e.key === 'Enter') {
                    handleEpInputBlur(anime);
                }
            };

            const startEditingEp = (anime) => {
                setEditingEpId(anime.id);
                setTempEpValue(String(anime.watched || 0));
            };

            return (
                <AnimatePresence>
                    {isOpen && (
                        <motion.div
                            initial={{ opacity: 0, backdropFilter: "blur(0px)" }}
                            animate={{ opacity: 1, backdropFilter: "blur(20px)" }}
                            exit={{ opacity: 0, backdropFilter: "blur(0px)" }}
                            className="fixed inset-0 z-[100] bg-black/90 overflow-y-auto no-flicker"
                        >
                            <div className="flex flex-col items-center min-h-screen pt-24 px-4 pb-20 w-full relative">
                                <button onClick={onClose} className="fixed top-6 right-6 z-[101] p-3 rounded-full bg-white/10 hover:bg-white/20 transition text-white border border-white/10 active:scale-95">
                                    <X size={20} />
                                </button>
                                
                                <div className="w-full max-w-6xl">
                                    <div className="flex flex-col md:flex-row justify-between items-end mb-8 border-b border-white/10 pb-4 gap-4">
                                        <div>
                                            <h2 className="font-oswald text-4xl md:text-6xl font-bold uppercase text-white leading-none">Profile <span className="accent-text">List</span></h2>
                                            <p className="font-grotesk text-white/40 text-sm mt-2 tracking-widest">MANAGE YOUR ANIME DATABASE</p>
                                        </div>
                                        <div className="flex gap-2 bg-white/5 p-1 rounded-lg">
                                            <button 
                                                onClick={() => setViewMode("grid")}
                                                className={`p-2 rounded transition-colors ${viewMode === 'grid' ? 'bg-[var(--accent)] text-black' : 'text-white/50 hover:text-white'}`}
                                            >
                                                <Grid size={20} />
                                            </button>
                                            <button 
                                                onClick={() => setViewMode("list")}
                                                className={`p-2 rounded transition-colors ${viewMode === 'list' ? 'bg-[var(--accent)] text-black' : 'text-white/50 hover:text-white'}`}
                                            >
                                                <List size={20} />
                                            </button>
                                        </div>
                                    </div>
                                    
                                    {favorites.length === 0 ? (
                                        <div className="text-center text-white/40 font-grotesk mt-20 p-12 border border-dashed border-white/10 rounded-2xl">
                                            <p className="text-xl mb-2">No frequencies stored in memory.</p>
                                            <p className="text-sm">Add to archives via the heart icon on any anime page.</p>
                                        </div>
                                    ) : (
                                            viewMode === 'grid' ? (
                                                <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4 md:gap-6">
                                                    {favorites.map((anime, i) => (
                                                        <motion.div
                                                            key={anime.id}
                                                            initial={{ opacity: 0, y: 20 }}
                                                            animate={{ opacity: 1, y: 0 }}
                                                            transition={{ delay: i * 0.05 }}
                                                            className="group relative cursor-pointer gpu-accelerated bg-white/5 rounded-xl border border-white/10 overflow-hidden hover:border-[var(--accent)] transition-colors"
                                                            onClick={() => { onSelect(anime); onClose(); }}
                                                        >
                                                            <div className="aspect-[2/3] overflow-hidden bg-black">
                                                                <img src={anime.image} alt={anime.title} className="h-full w-full object-cover transition-transform duration-500 group-hover:scale-105" />
                                                            </div>
                                                            <div className="p-3">
                                                                <h4 className="font-oswald text-sm leading-tight text-white group-hover:text-[var(--accent)] transition-colors line-clamp-1 mb-1">{anime.title}</h4>
                                                                <div className="flex justify-between items-center text-[10px] font-grotesk text-white/60">
                                                                    <span className="flex items-center gap-1">
                                                                        {getStatusIcon(anime.status)} {anime.status || 'Planning'}
                                                                    </span>
                                                                    <span className="bg-white/10 px-1.5 py-0.5 rounded">
                                                                        {anime.watched || 0}/{anime.totalEpisodes || '?'}
                                                                    </span>
                                                                </div>
                                                            </div>
                                                        </motion.div>
                                                    ))}
                                                </div>
                                            ) : (
                                                <div className="flex flex-col gap-3">
                                                    {favorites.map((anime, i) => (
                                                        <motion.div
                                                            key={anime.id}
                                                            initial={{ opacity: 0, x: -20 }}
                                                            animate={{ opacity: 1, x: 0 }}
                                                            transition={{ delay: i * 0.03 }}
                                                            className="flex flex-col md:flex-row items-start md:items-center gap-4 p-4 rounded-xl bg-white/5 border border-white/10 hover:border-white/30 transition-colors group"
                                                        >
                                                            {/* Info Section (Click to View) */}
                                                            <div 
                                                                className="flex items-center gap-4 flex-grow cursor-pointer"
                                                                onClick={() => { onSelect(anime); onClose(); }}
                                                            >
                                                                <div className="w-12 h-16 bg-black/50 rounded overflow-hidden flex-shrink-0 border border-white/10">
                                                                    <img src={anime.image} className="w-full h-full object-cover" />
                                                                </div>
                                                                <div className="flex-grow min-w-0">
                                                                    <h4 className="font-oswald text-lg text-white group-hover:text-[var(--accent)] transition-colors truncate">{anime.title}</h4>
                                                                    <p className="text-white/40 text-xs font-grotesk">Total Ep: {anime.totalEpisodes || '?'}</p>
                                                                </div>
                                                            </div>

                                                            {/* Controls Section (Prevent propagation to keep list open) */}
                                                            <div className="flex flex-wrap items-center justify-end gap-3 w-full md:w-auto mt-4 md:mt-0 pl-0 md:pl-4" onClick={(e) => e.stopPropagation()}>
                                                                
                                                                {/* Status Selector - Cyberpunk Style */}
                                                                <div className="relative group/select">
                                                                    <div className={`absolute inset-0 bg-current opacity-5 rounded-lg pointer-events-none ${getStatusColor(anime.status)}`}></div>
                                                                    <select 
                                                                        value={anime.status || "Planning"} 
                                                                        onChange={(e) => onUpdateEntry(anime.id, { status: e.target.value })}
                                                                        className={`appearance-none bg-transparent border text-xs font-oswald font-bold py-2 pl-3 pr-8 rounded-lg outline-none cursor-pointer uppercase tracking-wider w-[130px] transition-all ${getStatusColor(anime.status || 'Planning')} hover:bg-white/5`}
                                                                    >
                                                                        {STATUS_OPTIONS.map(s => <option key={s} value={s} className="bg-black text-white">{s.toUpperCase()}</option>)}
                                                                    </select>
                                                                    <div className={`absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none ${getStatusColor(anime.status || 'Planning').split(' ')[0]}`}>
                                                                        <div className="w-0 h-0 border-l-[4px] border-l-transparent border-r-[4px] border-r-transparent border-t-[4px] border-t-current"></div>
                                                                    </div>
                                                                </div>

                                                                {/* Episode Stepper - Digital Tuner Style */}
                                                                <div className="flex items-center gap-1 bg-black/40 border border-white/10 rounded-lg p-1 h-[36px]">
                                                                    <button 
                                                                        onClick={() => onUpdateEntry(anime.id, { watched: Math.max(0, (anime.watched || 0) - 1) })}
                                                                        className="w-8 h-full flex items-center justify-center rounded hover:bg-white/10 text-white/40 hover:text-white transition-colors active:scale-90"
                                                                    >
                                                                        <Minus size={12} />
                                                                    </button>
                                                                    
                                                                    <div 
                                                                        className="flex flex-col items-center justify-center w-20 h-full px-1 border-x border-white/5 bg-white/5 mx-1 relative overflow-hidden group/counter cursor-text"
                                                                        onClick={() => startEditingEp(anime)}
                                                                    >
                                                                        {editingEpId === anime.id ? (
                                                                            <input 
                                                                                type="text" 
                                                                                value={tempEpValue}
                                                                                onChange={(e) => handleEpInputChange(e, anime)}
                                                                                onBlur={() => handleEpInputBlur(anime)}
                                                                                onKeyDown={(e) => handleEpInputKeyDown(e, anime)}
                                                                                autoFocus
                                                                                className="w-full h-full bg-transparent text-center text-sm font-oswald font-bold text-white outline-none tabular-nums"
                                                                            />
                                                                        ) : (
                                                                            <span className="text-sm font-oswald font-bold text-white relative z-10 tabular-nums">
                                                                                {String(anime.watched || 0).padStart(2, '0')} <span className="text-[10px] text-white/30 font-grotesk">/ {anime.totalEpisodes || '?'}</span>
                                                                            </span>
                                                                        )}
                                                                        
                                                                        {/* Progress Bar Background */}
                                                                        <div 
                                                                            className="absolute bottom-0 left-0 h-[2px] bg-[var(--accent)] transition-all duration-300 opacity-50 group-hover/counter:opacity-100"
                                                                            style={{ width: `${Math.min(100, ((anime.watched || 0) / (anime.totalEpisodes || 1)) * 100)}%` }}
                                                                        />
                                                                    </div>

                                                                    <button 
                                                                        onClick={() => onUpdateEntry(anime.id, { watched: Math.min(anime.totalEpisodes || 9999, (anime.watched || 0) + 1) })}
                                                                        className="w-8 h-full flex items-center justify-center rounded hover:bg-white/10 text-white/40 hover:text-[var(--accent)] transition-colors active:scale-90"
                                                                    >
                                                                        <Plus size={12} />
                                                                    </button>
                                                                </div>

                                                                {/* Delete Button */}
                                                                <button 
                                                                    onClick={() => onDeleteEntry(anime.id)}
                                                                    className="w-[36px] h-[36px] flex items-center justify-center rounded-lg border border-white/5 hover:border-red-500/50 hover:bg-red-500/10 text-white/20 hover:text-red-500 transition-all ml-1"
                                                                    title="Remove"
                                                                >
                                                                    <Trash2 size={14} />
                                                                </button>
                                                            </div>
                                                        </motion.div>
                                                    ))}
                                                </div>
                                            )
                                    )}
                                </div>
                            </div>
                        </motion.div>
                    )}
                </AnimatePresence>
            );
        };

        // UPDATED: Profile & Auth Manager
        const ProfileOverlay = ({ isOpen, onClose, user, onLogin, onRegister, onLogout, error, clearError, favorites, db, pathAppId, onViewProfile }) => {
            // Auth States
            const [email, setEmail] = useState("");
            const [password, setPassword] = useState("");
            const [isRegistering, setIsRegistering] = useState(false);

            // Profile States
            const [profileData, setProfileData] = useState({
                displayName: "AGENT",
                bio: "No bio data available.",
                avatar: null,
                banner: "https://images.unsplash.com/photo-1577057867946-8e5033c46a60?q=80&w=2574&auto=format&fit=crop"
            });
            const [isEditing, setIsEditing] = useState(false);
            const [editForm, setEditForm] = useState({});
            const [isSaving, setIsSaving] = useState(false);
            
            // Network States
            const [activeTab, setActiveTab] = useState('identity');
            const [searchQuery, setSearchQuery] = useState("");
            const [searchResults, setSearchResults] = useState([]);
            const [connections, setConnections] = useState([]); // All connections involving me
            const [isSearching, setIsSearching] = useState(false);

            // Stats Calculation
            const stats = useMemo(() => {
                const completed = favorites.filter(f => f.status === 'Completed').length;
                const watching = favorites.filter(f => f.status === 'Watching').length;
                const totalEps = favorites.reduce((acc, curr) => acc + (curr.watched || 0), 0);
                const estimatedMinutes = totalEps * 24;
                const hours = Math.floor(estimatedMinutes / 60);
                return { completed, watching, totalEps, hours };
            }, [favorites]);

            // Derived Network Lists
            const { friends, incomingRequests, sentRequests } = useMemo(() => {
                if (!user) return { friends: [], incomingRequests: [], sentRequests: [] };
                
                const friends = [];
                const incomingRequests = [];
                const sentRequests = [];

                connections.forEach(conn => {
                    const isSender = conn.requesterUid === user.uid;
                    const otherUser = isSender ? conn.receiver : conn.sender;
                    
                    if (conn.status === 'connected') {
                        friends.push({ ...otherUser, connectionId: conn.id });
                    } else if (conn.status === 'pending') {
                        if (isSender) {
                            sentRequests.push({ ...otherUser, connectionId: conn.id });
                        } else {
                            incomingRequests.push({ ...otherUser, connectionId: conn.id });
                        }
                    }
                });

                return { friends, incomingRequests, sentRequests };
            }, [connections, user]);

            useEffect(() => {
                if(isOpen) {
                    if (!user) {
                        setEmail("");
                        setPassword("");
                        if(clearError) clearError();
                    } else {
                        // Load Private Profile
                        const loadProfile = async () => {
                            if (!db) return;
                            try {
                                const docRef = doc(db, 'artifacts', pathAppId, 'users', user.uid, 'settings', 'profile');
                                const docSnap = await getDoc(docRef);
                                if (docSnap.exists()) {
                                    setProfileData(prev => ({ ...prev, ...docSnap.data() }));
                                }
                            } catch(e) {
                                console.error("Error loading profile:", e);
                            }
                        };
                        loadProfile();
                    }
                    document.body.style.overflow = 'hidden';
                } else {
                    document.body.style.overflow = '';
                    setIsEditing(false);
                    setEditForm({}); 
                    setActiveTab('identity');
                }
                return () => { document.body.style.overflow = ''; }
            }, [isOpen, user]);

            // Real-time Fetch Connections (Public Collection for Mutual Access)
            useEffect(() => {
                if (!user || !db) return;
                
                // Fetch ALL connections from public directory (workaround for no complex queries)
                // In a real app with millions of users, this would be inefficient, but fits the constraints here.
                const q = collection(db, 'artifacts', pathAppId, 'public', 'data', 'connections');
                
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const allConns = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    // Filter connections involving current user
                    const myConns = allConns.filter(c => c.participants && c.participants.includes(user.uid));
                    setConnections(myConns);
                });
                
                return () => unsubscribe();
            }, [user]);

            // Initialize edit form
            useEffect(() => {
                if (isEditing) {
                    setEditForm(profileData);
                }
            }, [isEditing]);

            const handleAuthSubmit = (e) => {
                e.preventDefault();
                if (isRegistering) onRegister(email, password);
                else onLogin(email, password);
            };

            const handleSaveProfile = async () => {
                if (!user || !db) return;
                setIsSaving(true);
                try {
                    const docRef = doc(db, 'artifacts', pathAppId, 'users', user.uid, 'settings', 'profile');
                    const cleanForm = Object.fromEntries(
                        Object.entries(editForm).filter(([_, v]) => v !== undefined)
                    );
                    const newData = { ...profileData, ...cleanForm };
                    
                    // 1. Save Private Profile
                    await setDoc(docRef, newData, { merge: true });

                    // 2. Save Public Searchable Profile
                    const publicRef = doc(db, 'artifacts', pathAppId, 'public', 'data', 'profiles', user.uid);
                    await setDoc(publicRef, {
                        uid: user.uid,
                        displayName: newData.displayName,
                        avatar: newData.avatar,
                        agentId: user.uid.slice(0, 8).toUpperCase(),
                        updatedAt: Date.now()
                    }, { merge: true });

                    setProfileData(newData);
                    setIsEditing(false);
                } catch (e) {
                    console.error("Save failed", e);
                    alert("Failed to save. Check connection.");
                } finally {
                    setIsSaving(false);
                }
            };

            const handleSearchAgents = async () => {
                if (!searchQuery.trim() || !db) return;
                setIsSearching(true);
                try {
                    const querySnapshot = await getDocs(collection(db, 'artifacts', pathAppId, 'public', 'data', 'profiles'));
                    const allAgents = querySnapshot.docs.map(doc => doc.data());
                    
                    const qLower = searchQuery.toLowerCase();
                    const filtered = allAgents.filter(agent => 
                        agent.uid !== user.uid && (
                            (agent.displayName || "").toLowerCase().includes(qLower) || 
                            (agent.agentId || "").toLowerCase().includes(qLower)
                        )
                    );
                    setSearchResults(filtered);
                } catch (e) {
                    console.error("Search failed", e);
                } finally {
                    setIsSearching(false);
                }
            };

            // Network Actions
            const sendRequest = async (targetAgent) => {
                if (!user || !db) return;
                // Generate a unique ID based on sorted UIDs to prevent duplicate requests/connections
                const participants = [user.uid, targetAgent.uid].sort();
                const connectionId = participants.join('_');
                const ref = doc(db, 'artifacts', pathAppId, 'public', 'data', 'connections', connectionId);

                await setDoc(ref, {
                    participants,
                    requesterUid: user.uid,
                    status: 'pending',
                    timestamp: Date.now(),
                    // Store snapshot of users to display easily without fetching profiles again
                    sender: {
                        uid: user.uid,
                        displayName: profileData.displayName,
                        avatar: profileData.avatar,
                        agentId: user.uid.slice(0, 8).toUpperCase()
                    },
                    receiver: {
                        uid: targetAgent.uid,
                        displayName: targetAgent.displayName,
                        avatar: targetAgent.avatar,
                        agentId: targetAgent.agentId
                    }
                });
            };

            const acceptRequest = async (connectionId) => {
                if (!db) return;
                const ref = doc(db, 'artifacts', pathAppId, 'public', 'data', 'connections', connectionId);
                await updateDoc(ref, { status: 'connected' });
            };

            const removeConnection = async (connectionId) => {
                if (!db) return;
                const ref = doc(db, 'artifacts', pathAppId, 'public', 'data', 'connections', connectionId);
                await deleteDoc(ref);
            };

            const getConnectionStatus = (targetUid) => {
                const conn = connections.find(c => c.participants.includes(targetUid));
                if (!conn) return 'none';
                if (conn.status === 'connected') return 'connected';
                if (conn.requesterUid === user.uid) return 'sent';
                return 'received';
            };

            const handleFileUpload = (e, field) => {
                const file = e.target.files[0];
                if (!file) return;
                if (file.size > 500000) { 
                    alert("File too large. Maximum size is 500KB.");
                    return;
                }
                const reader = new FileReader();
                reader.onloadend = () => {
                    if (reader.result) {
                        setEditForm(prev => ({ ...prev, [field]: reader.result }));
                    }
                };
                reader.readAsDataURL(file);
            };

            return (
                <AnimatePresence>
                    {isOpen && (
                        <motion.div
                            initial={{ opacity: 0 }}
                            animate={{ opacity: 1 }}
                            exit={{ opacity: 0 }}
                            className="fixed inset-0 z-[200] bg-black/95 backdrop-blur-md overflow-y-auto"
                        >
                            <button onClick={onClose} className="fixed top-6 right-6 z-[201] p-3 rounded-full bg-black/50 hover:bg-white/20 transition text-white border border-white/10 active:scale-95 group">
                                <X size={24} className="group-hover:rotate-90 transition-transform duration-300" />
                            </button>

                            {(!user || user.isAnonymous) ? (
                                <div className="min-h-screen flex items-center justify-center p-4">
                                     <motion.div 
                                        initial={{ y: 30, opacity: 0 }} 
                                        animate={{ y: 0, opacity: 1 }} 
                                        transition={{ delay: 0.1 }}
                                        className="relative z-10 w-full max-w-md"
                                    >
                                        <div className="text-center mb-12">
                                            <h2 className="font-oswald text-6xl font-bold uppercase text-white mb-2 tracking-tighter">
                                                System <span className="text-stroke">Access</span>
                                            </h2>
                                            <p className="font-grotesk text-[var(--accent)] text-sm tracking-widest uppercase">
                                                /// AUTHENTICATION REQUIRED
                                            </p>
                                        </div>

                                        <div className="bg-[#0a0a0a]/80 backdrop-blur-xl border border-white/10 rounded-2xl p-8 shadow-2xl">
                                            {error && (
                                                <div className="mb-6 p-4 bg-red-500/10 border-l-2 border-red-500 text-red-200 text-xs font-grotesk">
                                                    <span className="font-bold block mb-1">ERROR CODE: AUTH_FAIL</span>
                                                    {error}
                                                </div>
                                            )}

                                            <form onSubmit={handleAuthSubmit} className="flex flex-col gap-6">
                                                <div className="group relative">
                                                    <Mail className="absolute left-0 top-3 text-white/30 group-focus-within:text-[var(--accent)] transition-colors" size={20} />
                                                    <input 
                                                        type="email" 
                                                        placeholder="AGENT ID (EMAIL)" 
                                                        value={email}
                                                        onChange={(e) => setEmail(e.target.value)}
                                                        className="w-full bg-transparent border-b border-white/20 py-3 pl-8 text-white font-grotesk outline-none focus:border-[var(--accent)] transition-colors placeholder:text-white/20"
                                                        required
                                                    />
                                                </div>
                                                <div className="group relative">
                                                    <Lock className="absolute left-0 top-3 text-white/30 group-focus-within:text-[var(--accent)] transition-colors" size={20} />
                                                    <input 
                                                        type="password" 
                                                        placeholder="ACCESS KEY (PASSWORD)" 
                                                        value={password}
                                                        onChange={(e) => setPassword(e.target.value)}
                                                        className="w-full bg-transparent border-b border-white/20 py-3 pl-8 text-white font-grotesk outline-none focus:border-[var(--accent)] transition-colors placeholder:text-white/20"
                                                        required
                                                    />
                                                </div>

                                                <button type="submit" className="mt-4 w-full py-4 bg-white text-black font-oswald font-bold text-lg uppercase tracking-widest hover:bg-[var(--accent)] transition-colors rounded-lg flex items-center justify-center gap-2">
                                                    {isRegistering ? <Key size={20} /> : <LogIn size={20} />}
                                                    <span>{isRegistering ? "Initialize New Agent" : "Access Mainframe"}</span>
                                                </button>
                                            </form>

                                            <div className="mt-8 text-center">
                                                <button onClick={() => { setIsRegistering(!isRegistering); if(clearError) clearError(); }} className="text-xs font-grotesk text-white/40 hover:text-white transition-colors uppercase tracking-widest border-b border-transparent hover:border-white">
                                                    {isRegistering ? "Return to Login Sequence" : "New User? Request Access"}
                                                </button>
                                            </div>
                                        </div>
                                    </motion.div>
                                </div>
                            ) : (
                                /* --- LOGGED IN PROFILE STATE --- */
                                <div className="min-h-screen w-full bg-[#050505] flex flex-col">
                                    {/* Tab Navigation */}
                                    <div className="fixed top-0 left-0 w-full z-50 flex justify-center py-6 pointer-events-none">
                                        <div className="bg-black/50 backdrop-blur-md border border-white/10 rounded-full p-1 flex gap-1 pointer-events-auto shadow-2xl">
                                            <button 
                                                onClick={() => setActiveTab('identity')}
                                                className={`px-6 py-2 rounded-full font-oswald text-sm uppercase tracking-widest transition-all ${activeTab === 'identity' ? 'bg-white text-black font-bold' : 'text-white/50 hover:text-white hover:bg-white/5'}`}
                                            >
                                                Identity
                                            </button>
                                            <button 
                                                onClick={() => setActiveTab('network')}
                                                className={`px-6 py-2 rounded-full font-oswald text-sm uppercase tracking-widest transition-all ${activeTab === 'network' ? 'bg-[var(--accent)] text-black font-bold' : 'text-white/50 hover:text-white hover:bg-white/5'}`}
                                            >
                                                Network
                                                {incomingRequests.length > 0 && <span className="ml-2 w-2 h-2 rounded-full bg-red-500 inline-block align-middle animate-pulse"></span>}
                                            </button>
                                        </div>
                                    </div>

                                    {activeTab === 'identity' ? (
                                        <>
                                            {/* Banner */}
                                            <div className="relative h-[30vh] md:h-[40vh] w-full overflow-hidden bg-white/5">
                                                <div className="absolute inset-0 bg-gradient-to-t from-[#050505] to-transparent z-10" />
                                                <img 
                                                    key={isEditing ? (editForm.banner || profileData.banner) : profileData.banner} 
                                                    src={isEditing ? (editForm.banner || profileData.banner) : profileData.banner} 
                                                    className="w-full h-full object-cover opacity-60" 
                                                    alt="Banner" 
                                                    onError={(e) => e.target.style.display = 'none'}
                                                />
                                                {isEditing && (
                                                    <div className="absolute inset-0 z-20 flex items-center justify-center bg-black/20 backdrop-blur-[2px]">
                                                        <label className="cursor-pointer px-6 py-3 bg-black/50 backdrop-blur-md border border-white/20 rounded-full text-white font-oswald uppercase tracking-widest hover:bg-[var(--accent)] hover:text-black transition-colors shadow-xl">
                                                            Change Banner
                                                            <input type="file" accept="image/*" className="hidden" onChange={(e) => handleFileUpload(e, 'banner')} />
                                                        </label>
                                                    </div>
                                                )}
                                            </div>

                                            <div className="max-w-7xl mx-auto px-6 relative z-20 -mt-20 md:-mt-32 pb-20 w-full">
                                                <div className="flex flex-col md:flex-row items-end gap-8 mb-12">
                                                    {/* Avatar */}
                                                    <div className="relative group shrink-0">
                                                        <div className="w-32 h-32 md:w-48 md:h-48 rounded-full border-4 border-[#050505] bg-black overflow-hidden relative">
                                                            {(isEditing ? (editForm.avatar || profileData.avatar) : profileData.avatar) ? (
                                                                <img 
                                                                    key={isEditing ? (editForm.avatar || profileData.avatar) : profileData.avatar}
                                                                    src={isEditing ? (editForm.avatar || profileData.avatar) : profileData.avatar} 
                                                                    className="w-full h-full object-cover" 
                                                                    alt="Avatar" 
                                                                    onError={(e) => { e.target.style.display = 'none'; e.target.parentElement.classList.add('fallback-avatar'); }}
                                                                />
                                                            ) : (
                                                                <div className="w-full h-full flex items-center justify-center bg-white/10"><User size={64} className="text-white/20" /></div>
                                                            )}
                                                            {isEditing && (
                                                                <div className="absolute inset-0 flex items-center justify-center bg-black/60 cursor-pointer z-30 transition-colors hover:bg-black/40">
                                                                    <label className="w-full h-full flex flex-col items-center justify-center gap-1 cursor-pointer">
                                                                        <input type="file" accept="image/*" className="hidden" onChange={(e) => handleFileUpload(e, 'avatar')} />
                                                                        <div className="p-2 bg-white/10 rounded-full mb-1"><User size={20} /></div>
                                                                        <span className="text-[var(--accent)] font-bold text-xs uppercase tracking-widest">Upload</span>
                                                                    </label>
                                                                </div>
                                                            )}
                                                        </div>
                                                    </div>

                                                    {/* Header Info */}
                                                    <div className="flex-grow w-full">
                                                        <div className="flex flex-col md:flex-row justify-between items-start md:items-end gap-4">
                                                            <div>
                                                                {isEditing ? (
                                                                    <input 
                                                                        type="text" 
                                                                        value={editForm.displayName !== undefined ? editForm.displayName : profileData.displayName}
                                                                        onChange={(e) => setEditForm({...editForm, displayName: e.target.value})}
                                                                        className="bg-white/5 border-b border-white/20 text-3xl md:text-4xl font-oswald font-bold text-white w-full md:w-[400px] outline-none mb-2 rounded-t px-2"
                                                                        placeholder="DISPLAY NAME"
                                                                    />
                                                                ) : (
                                                                    <h1 className="text-5xl md:text-7xl font-oswald font-bold text-white uppercase tracking-tighter leading-none break-words">
                                                                        {profileData.displayName}
                                                                    </h1>
                                                                )}
                                                                <p className="text-[var(--accent)] font-grotesk tracking-widest uppercase text-xs md:text-sm mt-2 flex items-center gap-2">
                                                                    /// AGENT ID: {user.uid.slice(0, 8).toUpperCase()}
                                                                    <span className="px-2 py-0.5 bg-white/10 rounded text-[10px] text-white/50">PUBLIC</span>
                                                                </p>
                                                            </div>
                                                            
                                                            <div className="flex gap-3 w-full md:w-auto shrink-0">
                                                                {isEditing ? (
                                                                    <>
                                                                        <button onClick={() => setIsEditing(false)} disabled={isSaving} className="flex-1 md:flex-none px-6 py-2 border border-red-500/50 text-red-400 font-oswald uppercase hover:bg-red-500/10 transition disabled:opacity-50 text-sm md:text-base">Cancel</button>
                                                                        <button onClick={handleSaveProfile} disabled={isSaving} className="flex-1 md:flex-none px-6 py-2 bg-[var(--accent)] text-black font-oswald uppercase font-bold hover:brightness-110 transition disabled:opacity-50 disabled:cursor-not-allowed text-sm md:text-base">
                                                                            {isSaving ? "Saving..." : "Save"}
                                                                        </button>
                                                                    </>
                                                                ) : (
                                                                    <>
                                                                        <button onClick={() => setIsEditing(true)} className="flex-1 md:flex-none px-6 py-2 border border-white/20 text-white font-oswald uppercase hover:bg-white/10 transition text-sm md:text-base">Edit Profile</button>
                                                                        <button onClick={() => { onLogout(); onClose(); }} className="px-4 py-2 bg-white/5 text-white/40 hover:text-red-400 hover:bg-red-500/10 transition"><LogOut size={20} /></button>
                                                                    </>
                                                                )}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div className="grid grid-cols-1 lg:grid-cols-3 gap-8 md:gap-12">
                                                    {/* Left Column: Bio & Stats */}
                                                    <div className="space-y-8">
                                                        <div className="bg-white/5 border border-white/10 rounded-2xl p-6 backdrop-blur-sm">
                                                            <h3 className="font-oswald text-xl uppercase text-white/50 mb-4">Bio_Data</h3>
                                                            {isEditing ? (
                                                                <textarea 
                                                                    value={editForm.bio !== undefined ? editForm.bio : profileData.bio}
                                                                    onChange={(e) => setEditForm({...editForm, bio: e.target.value})}
                                                                    className="w-full bg-black/50 border border-white/10 rounded p-3 text-white font-grotesk text-base min-h-[100px] outline-none focus:border-[var(--accent)]"
                                                                    placeholder="Enter user biography..."
                                                                />
                                                            ) : (
                                                                <p className="font-grotesk text-white/80 leading-relaxed text-sm md:text-base">
                                                                    {profileData.bio}
                                                                </p>
                                                            )}
                                                        </div>

                                                        <div className="bg-white/5 border border-white/10 rounded-2xl p-6 backdrop-blur-sm">
                                                            <h3 className="font-oswald text-xl uppercase text-white/50 mb-6">Sync_Stats</h3>
                                                            <div className="grid grid-cols-2 gap-4">
                                                                <div className="p-4 bg-black/40 rounded-xl border border-white/5">
                                                                    <div className="text-white/40 text-[10px] font-grotesk uppercase tracking-widest mb-1">Total Time</div>
                                                                    <div className="text-2xl font-oswald font-bold text-white">{stats.hours}<span className="text-xs text-white/40 ml-1">HRS</span></div>
                                                                </div>
                                                                <div className="p-4 bg-black/40 rounded-xl border border-white/5">
                                                                    <div className="text-white/40 text-[10px] font-grotesk uppercase tracking-widest mb-1">Episodes</div>
                                                                    <div className="text-2xl font-oswald font-bold text-[var(--accent)]">{stats.totalEps}</div>
                                                                </div>
                                                                <div className="p-4 bg-black/40 rounded-xl border border-white/5">
                                                                    <div className="text-white/40 text-[10px] font-grotesk uppercase tracking-widest mb-1">Completed</div>
                                                                    <div className="text-2xl font-oswald font-bold text-green-400">{stats.completed}</div>
                                                                </div>
                                                                <div className="p-4 bg-black/40 rounded-xl border border-white/5">
                                                                    <div className="text-white/40 text-[10px] font-grotesk uppercase tracking-widest mb-1">Active</div>
                                                                    <div className="text-2xl font-oswald font-bold text-blue-400">{stats.watching}</div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    {/* Right Column: Recent Activity */}
                                                    <div className="lg:col-span-2">
                                                        <h3 className="font-oswald text-2xl uppercase text-white mb-6 border-b border-white/10 pb-2">Recent <span className="text-[var(--accent)]">Uplinks</span></h3>
                                                        
                                                        {favorites.length === 0 ? (
                                                            <div className="w-full h-40 border border-dashed border-white/10 rounded-2xl flex items-center justify-center text-white/30 font-grotesk uppercase tracking-widest">
                                                                No data streams found
                                                            </div>
                                                        ) : (
                                                            <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                                                                {favorites.slice(0, 6).map((fav, i) => (
                                                                    <div key={fav.id} className="group relative aspect-video rounded-xl overflow-hidden bg-white/5 border border-white/10">
                                                                        <img src={fav.image} className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110 opacity-60 group-hover:opacity-100" />
                                                                        <div className="absolute inset-0 bg-gradient-to-t from-black via-transparent to-transparent" />
                                                                        <div className="absolute bottom-0 left-0 p-3 w-full">
                                                                            <h4 className="font-oswald text-sm text-white truncate">{fav.title}</h4>
                                                                            <div className="flex justify-between items-center mt-1">
                                                                                <span className={`text-[10px] px-1.5 py-0.5 rounded ${fav.status === 'Watching' ? 'bg-blue-500/20 text-blue-300' : 'bg-green-500/20 text-green-300'}`}>
                                                                                    {fav.status}
                                                                                </span>
                                                                                <span className="text-[10px] font-grotesk text-white/60">{fav.watched} eps</span>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        )}

                                                        {isEditing && (
                                                            <div className="mt-8 p-4 bg-yellow-500/10 border border-yellow-500/20 rounded-xl">
                                                                <h4 className="text-[var(--accent)] font-oswald text-sm uppercase mb-1">Tip: Image Uploads</h4>
                                                                <p className="text-white/60 text-xs font-grotesk">
                                                                    You can click the image to upload (Max 500KB) OR paste a direct URL below.
                                                                </p>
                                                                <div className="mt-2 flex flex-col gap-2">
                                                                    <input 
                                                                        type="text" 
                                                                        placeholder="Paste Banner URL here" 
                                                                        value={editForm.banner && !editForm.banner.startsWith('data:') ? editForm.banner : ""}
                                                                        onChange={(e) => setEditForm({...editForm, banner: e.target.value})}
                                                                        className="w-full bg-black/40 border border-white/10 rounded p-2 text-sm text-white outline-none focus:border-[var(--accent)]"
                                                                    />
                                                                    <input 
                                                                        type="text" 
                                                                        placeholder="Paste Avatar URL here" 
                                                                        value={editForm.avatar && !editForm.avatar.startsWith('data:') ? editForm.avatar : ""}
                                                                        onChange={(e) => setEditForm({...editForm, avatar: e.target.value})}
                                                                        className="w-full bg-black/40 border border-white/10 rounded p-2 text-sm text-white outline-none focus:border-[var(--accent)]"
                                                                    />
                                                                </div>
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                            </div>
                                        </>
                                    ) : (
                                        /* --- NETWORK TAB --- */
                                        <div className="flex-grow pt-24 pb-20 px-4 md:px-8 max-w-5xl mx-auto w-full">
                                            <div className="mb-8 text-center">
                                                <h2 className="font-oswald text-4xl text-white uppercase tracking-tighter">Agent <span className="text-[var(--accent)]">Directory</span></h2>
                                                <p className="text-white/40 font-grotesk text-sm mt-2">SEARCH MAINFRAME FOR ALLIES</p>
                                            </div>

                                            <div className="relative mb-12">
                                                <div className="flex gap-2">
                                                    <input 
                                                        type="text" 
                                                        value={searchQuery}
                                                        onChange={(e) => setSearchQuery(e.target.value)}
                                                        onKeyDown={(e) => e.key === 'Enter' && handleSearchAgents()}
                                                        placeholder="SEARCH BY AGENT ID OR NAME..." 
                                                        className="w-full bg-white/5 border border-white/10 rounded-xl px-6 py-4 text-white font-oswald text-xl uppercase tracking-wider outline-none focus:border-[var(--accent)] focus:bg-white/10 transition-colors"
                                                    />
                                                    <button 
                                                        onClick={handleSearchAgents} 
                                                        disabled={isSearching}
                                                        className="bg-[var(--accent)] text-black px-6 rounded-xl font-bold uppercase font-oswald hover:brightness-110 transition disabled:opacity-50"
                                                    >
                                                        {isSearching ? <div className="animate-spin"><Shuffle size={20}/></div> : <Search size={24} />}
                                                    </button>
                                                </div>
                                            </div>

                                            {/* Incoming Requests Section */}
                                            {incomingRequests.length > 0 && (
                                                <div className="mb-12">
                                                    <h3 className="font-oswald text-[var(--accent)] uppercase mb-4 text-sm tracking-widest border-b border-[var(--accent)]/30 pb-2">Incoming Requests ({incomingRequests.length})</h3>
                                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                        {incomingRequests.map(req => (
                                                            <div key={req.connectionId} className="bg-[var(--accent)]/5 border border-[var(--accent)]/30 p-4 rounded-xl flex items-center justify-between">
                                                                <div className="flex items-center gap-4">
                                                                    <div className="w-12 h-12 rounded-full bg-black border border-[var(--accent)]/50 overflow-hidden">
                                                                        {req.avatar ? <img src={req.avatar} className="w-full h-full object-cover" /> : <div className="w-full h-full flex items-center justify-center"><User size={20} className="text-[var(--accent)]/50" /></div>}
                                                                    </div>
                                                                    <div>
                                                                        <h4 className="font-oswald text-lg text-white uppercase leading-none">{req.displayName}</h4>
                                                                        <p className="text-[var(--accent)] text-xs font-grotesk tracking-widest mt-1">ID: {req.agentId}</p>
                                                                    </div>
                                                                </div>
                                                                <div className="flex gap-2">
                                                                    <button onClick={() => removeConnection(req.connectionId)} className="p-2 text-red-400 hover:bg-red-500/10 rounded-lg"><X size={18}/></button>
                                                                    <button onClick={() => acceptRequest(req.connectionId)} className="px-4 py-2 bg-[var(--accent)] text-black font-oswald text-xs font-bold uppercase rounded-lg hover:brightness-110">Accept</button>
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            )}

                                            {/* Search Results Section */}
                                            {searchResults.length > 0 && (
                                                <div className="mb-12">
                                                    <h3 className="font-oswald text-white/50 uppercase mb-4 text-sm tracking-widest">Search Results</h3>
                                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                        {searchResults.map(agent => {
                                                            const status = getConnectionStatus(agent.uid);
                                                            return (
                                                                <div 
                                                                    key={agent.uid} 
                                                                    className="bg-white/5 border border-white/10 p-4 rounded-xl flex items-center justify-between group hover:border-white/30 transition-colors cursor-pointer"
                                                                    onClick={() => onViewProfile(agent.uid)}
                                                                >
                                                                    <div className="flex items-center gap-4">
                                                                        <div className="w-12 h-12 rounded-full bg-black border border-white/10 overflow-hidden">
                                                                            {agent.avatar ? <img src={agent.avatar} className="w-full h-full object-cover" /> : <div className="w-full h-full flex items-center justify-center"><User size={20} className="text-white/30" /></div>}
                                                                        </div>
                                                                        <div>
                                                                            <h4 className="font-oswald text-lg text-white uppercase leading-none">{agent.displayName}</h4>
                                                                            <p className="text-white/40 text-xs font-grotesk tracking-widest mt-1">ID: {agent.agentId}</p>
                                                                        </div>
                                                                    </div>
                                                                    
                                                                    <div onClick={(e) => e.stopPropagation()}>
                                                                        {status === 'none' && (
                                                                            <button onClick={() => sendRequest(agent)} className="px-4 py-2 bg-white/10 text-white font-oswald text-xs uppercase rounded-lg hover:bg-white/20">Connect</button>
                                                                        )}
                                                                        {status === 'sent' && (
                                                                            <span className="px-4 py-2 text-white/30 font-oswald text-xs uppercase">Pending</span>
                                                                        )}
                                                                        {status === 'received' && (
                                                                            <span className="px-4 py-2 text-[var(--accent)] font-oswald text-xs uppercase">Action Req.</span>
                                                                        )}
                                                                        {status === 'connected' && (
                                                                            <span className="px-4 py-2 text-green-400 font-oswald text-xs uppercase">Connected</span>
                                                                        )}
                                                                    </div>
                                                                </div>
                                                            );
                                                        })}
                                                    </div>
                                                </div>
                                            )}

                                            {/* Friends Section */}
                                            <div>
                                                <h3 className="font-oswald text-white/50 uppercase mb-4 text-sm tracking-widest border-b border-white/10 pb-2">Your Network ({friends.length})</h3>
                                                {friends.length === 0 ? (
                                                    <div className="text-center py-12 border border-dashed border-white/10 rounded-xl">
                                                        <p className="text-white/30 font-grotesk uppercase tracking-widest text-sm">No confirmed uplinks</p>
                                                    </div>
                                                ) : (
                                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                        {friends.map(friend => (
                                                            <div 
                                                                key={friend.uid} 
                                                                className="bg-black/40 border border-white/5 p-4 rounded-xl flex items-center justify-between cursor-pointer hover:bg-white/5 transition-colors"
                                                                onClick={() => onViewProfile(friend.uid)}
                                                            >
                                                                <div className="flex items-center gap-4">
                                                                    <div className="w-12 h-12 rounded-full bg-black border border-white/10 overflow-hidden">
                                                                        {friend.avatar ? <img src={friend.avatar} className="w-full h-full object-cover" /> : <div className="w-full h-full flex items-center justify-center"><User size={20} className="text-white/30" /></div>}
                                                                    </div>
                                                                    <div>
                                                                        <h4 className="font-oswald text-lg text-white uppercase leading-none">{friend.displayName}</h4>
                                                                        <p className="text-green-500/60 text-xs font-grotesk tracking-widest mt-1">â— ONLINE</p>
                                                                    </div>
                                                                </div>
                                                                <button 
                                                                    onClick={(e) => { e.stopPropagation(); removeConnection(friend.connectionId); }}
                                                                    className="text-white/20 hover:text-red-500 p-2 transition-colors"
                                                                    title="Disconnect"
                                                                >
                                                                    <Trash2 size={18} />
                                                                </button>
                                                            </div>
                                                        ))}
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}
                        </motion.div>
                    )}
                </AnimatePresence>
            );
        };

        const SearchOverlay = ({ isOpen, onClose, onSelect }) => {
            const [query, setQuery] = useState("");
            const [activeGenre, setActiveGenre] = useState(null);
            const [results, setResults] = useState([]);
            const [loading, setLoading] = useState(false);
            const inputRef = useRef(null);
            const abortControllerRef = useRef(null);

            useEffect(() => {
                if (isOpen) {
                    document.body.style.overflow = 'hidden';
                    if (inputRef.current) setTimeout(() => inputRef.current.focus(), 100);
                } else {
                    document.body.style.overflow = '';
                }
                return () => { document.body.style.overflow = ''; }
            }, [isOpen]);

            useEffect(() => {
                if (abortControllerRef.current) abortControllerRef.current.abort();
                abortControllerRef.current = new AbortController();
                const signal = abortControllerRef.current.signal;

                const delayDebounceFn = setTimeout(async () => {
                    if (query.trim().length > 2 || activeGenre) {
                        setLoading(true);
                        try {
                            let endpoint = `https://kitsu.io/api/edge/anime?page[limit]=10`;
                            if (query.trim().length > 0) endpoint += `&filter[text]=${encodeURIComponent(query)}`;
                            else if (activeGenre) endpoint += `&filter[categories]=${encodeURIComponent(activeGenre)}`;

                            const res = await fetch(endpoint, { signal });
                            const json = await res.json();
                            
                            if (!signal.aborted && json.data) {
                                setResults(json.data.map(item => ({
                                    id: item.id,
                                    title: item.attributes.canonicalTitle,
                                    image: item.attributes.posterImage?.small,
                                    year: item.attributes.startDate ? item.attributes.startDate.substring(0, 4) : 'TBA',
                                    score: item.attributes.averageRating ? Math.round(item.attributes.averageRating) : null,
                                    rank: item.attributes.ratingRank || item.attributes.popularityRank || "--",
                                    attributes: item.attributes
                                })));
                            }
                        } catch (e) {
                            if (e.name !== 'AbortError') console.error(e);
                        } finally {
                            if (!signal.aborted) setLoading(false);
                        }
                    } else {
                        setResults([]);
                        setLoading(false);
                    }
                }, 400);

                return () => clearTimeout(delayDebounceFn);
            }, [query, activeGenre]);

            return (
                <AnimatePresence>
                    {isOpen && (
                        <motion.div
                            initial={{ opacity: 0, backdropFilter: "blur(0px)" }}
                            animate={{ opacity: 1, backdropFilter: "blur(16px)" }}
                            exit={{ opacity: 0, backdropFilter: "blur(0px)" }}
                            transition={{ duration: 0.3 }}
                            className="fixed inset-0 z-[100] bg-black/80 overflow-y-auto overflow-x-hidden no-flicker"
                        >
                            <div className="flex flex-col items-center min-h-screen pt-24 px-4 pb-20 w-full relative">
                                <button onClick={onClose} className="fixed top-6 right-6 z-[101] p-3 rounded-full bg-white/10 hover:bg-white/20 transition text-white border border-white/10 active:scale-95">
                                    <X size={20} />
                                </button>
                                <motion.div initial={{ y: 20, opacity: 0 }} animate={{ y: 0, opacity: 1 }} className="w-full max-w-4xl relative shrink-0">
                                    <input
                                        ref={inputRef}
                                        placeholder="SEARCH ARCHIVES..."
                                        value={query}
                                        onChange={(e) => { setActiveGenre(null); setQuery(e.target.value); }}
                                        className="w-full bg-transparent border-b-2 border-white/20 py-4 md:py-8 text-center font-oswald text-2xl md:text-6xl font-bold uppercase text-white placeholder-white/10 outline-none focus:border-[var(--accent)] transition-colors"
                                    />
                                </motion.div>
                                <motion.div initial={{ y: 20, opacity: 0 }} animate={{ y: 0, opacity: 1 }} transition={{ delay: 0.1 }} className="mt-8 w-full max-w-4xl">
                                    <div className="flex flex-wrap gap-2 justify-center">
                                        {GENRES.map((genre) => (
                                            <button key={genre} onClick={() => { setQuery(""); setActiveGenre(genre === activeGenre ? null : genre); }} className={`px-4 md:px-5 py-2 rounded-full border text-xs font-bold uppercase tracking-widest transition-all duration-300 active:scale-95 ${activeGenre === genre ? 'bg-[var(--accent)] text-black border-[var(--accent)]' : 'bg-transparent text-white/50 border-white/10 hover:border-white/40 hover:text-white'}`}>{genre}</button>
                                        ))}
                                    </div>
                                </motion.div>
                                <div className="mt-12 w-full max-w-6xl grid grid-cols-2 md:grid-cols-5 gap-4 md:gap-6">
                                    {loading ? [...Array(10)].map((_, i) => <div key={i} className="aspect-[2/3] rounded-xl bg-white/5 animate-pulse border border-white/5" />) : (
                                        results.map((anime, i) => (
                                            <motion.div key={anime.id} initial={{ opacity: 0, scale: 0.9 }} animate={{ opacity: 1, scale: 1 }} transition={{ duration: 0.3, delay: i * 0.03 }} className="group relative cursor-pointer gpu-accelerated" onClick={() => onSelect(anime)}>
                                                <div className="aspect-[2/3] overflow-hidden rounded-xl bg-white/5 mb-3 border border-white/10 group-hover:border-[var(--accent)] transition-colors">
                                                    <img loading="lazy" src={anime.image} alt={anime.title} className="h-full w-full object-cover transition-transform duration-500 group-hover:scale-105" />
                                                </div>
                                                {anime.score && <div className="absolute top-2 right-2 px-2 py-1 bg-black/80 backdrop-blur-sm rounded border border-white/10 flex items-center gap-1 z-10"><Star size={8} className="text-[var(--accent)] fill-[var(--accent)]" /><span className="text-[10px] font-bold font-oswald text-white">{anime.score}</span></div>}
                                                <h4 className="font-oswald text-sm leading-tight text-white group-hover:text-[var(--accent)] transition-colors line-clamp-1">{anime.title}</h4>
                                                <p className="font-grotesk text-[10px] text-white/40 mt-1">{anime.year}</p>
                                            </motion.div>
                                        ))
                                    )}
                                </div>
                            </div>
                        </motion.div>
                    )}
                </AnimatePresence>
            );
        };

        const Counter = ({ value }) => {
            const ref = useRef(null);
            const motionValue = useMotionValue(0);
            const springValue = useSpring(motionValue, { damping: 30, stiffness: 100 });
            const isInView = useInView(ref, { once: true, margin: "0px" });
            useEffect(() => { if (isInView) motionValue.set(value); }, [isInView, value]);
            useEffect(() => springValue.on("change", (latest) => { if (ref.current) ref.current.textContent = Number.isInteger(value) ? Math.floor(latest).toFixed(0) : latest.toFixed(1); }), [springValue, value]);
            return <span ref={ref} />;
        };

        const DonutChart = ({ score, color }) => {
            const radius = 40;
            const circumference = 2 * Math.PI * radius;
            const fillPercent = (score / 10) * circumference;
            return (
                <div className="relative w-24 h-24 flex items-center justify-center">
                    <svg className="w-full h-full -rotate-90" viewBox="0 0 100 100">
                        <circle cx="50" cy="50" r={radius} stroke="#333" strokeWidth="8" fill="transparent" />
                        <motion.circle cx="50" cy="50" r={radius} stroke={color} strokeWidth="8" fill="transparent" strokeDasharray={circumference} initial={{ strokeDashoffset: circumference }} whileInView={{ strokeDashoffset: circumference - fillPercent }} viewport={{ once: true }} transition={{ duration: 1.5, ease: "easeOut" }} strokeLinecap="round" />
                    </svg>
                    <div className="absolute inset-0 flex items-center justify-center font-oswald text-2xl font-bold text-white"><Counter value={score} /></div>
                </div>
            );
        };

        const BentoCard = ({ title, value, sub, icon: Icon, delay = 0, isScore = false, color, isStudio = false }) => {
            return (
                <motion.div
                    initial={{ opacity: 0, y: 30 }}
                    whileInView={{ opacity: 1, y: 0 }}
                    viewport={{ once: true, margin: "-10%" }}
                    transition={{ duration: 0.6, delay, ease: "easeOut" }}
                    className={`group relative overflow-hidden rounded-3xl p-4 md:p-6 backdrop-blur-md transition-all hover:translate-y-[-4px] ${isStudio ? 'accent-bg text-black' : 'border border-white/10 bg-white/5 hover:bg-white/10'}`}
                    style={!isStudio ? { borderColor: 'rgba(255,255,255,0.1)' } : {}}
                >
                    <div className="absolute -right-4 -top-4 opacity-10 transition-transform duration-500 group-hover:scale-110 group-hover:rotate-12">{Icon && <Icon size={100} className="md:w-[120px] md:h-[120px]" />}</div>
                    <div className="relative z-10 flex h-full flex-col justify-between">
                        <h3 className={`font-grotesk text-xs md:text-sm uppercase tracking-widest ${isStudio ? 'text-black/60 font-bold' : 'text-white/50'}`}>{title}</h3>
                        {isScore ? (
                            <div className="mt-2 md:mt-4 flex items-end gap-4"><DonutChart score={Number(value)} color={color} /><div className="mb-2"><span className="block text-[10px] md:text-xs text-white/40">MASTERPIECE</span><span className="block text-[10px] md:text-xs accent-text">CRITICAL ACCLAIM</span></div></div>
                        ) : isStudio ? (
                            <div className="mt-2 md:mt-4"><ArrowUpRight className="absolute top-4 right-4 md:top-6 md:right-6 transition-transform group-hover:rotate-45" size={24}/><div className="font-oswald text-2xl md:text-3xl font-bold uppercase leading-none break-words">{value}</div></div>
                        ) : (
                            <div className="mt-2 md:mt-4"><div className="font-oswald text-3xl md:text-5xl font-bold text-white tracking-tight flex items-baseline gap-1">
                                {typeof value === 'string' && value.includes('#') && <span className="text-xl md:text-2xl align-top text-[var(--accent)]">#</span>}
                                {(() => {
                                    const numeric = typeof value === 'string' ? parseFloat(value.replace(/[^0-9.]/g, '')) : value;
                                    if (isNaN(numeric)) return <span>{typeof value === 'string' ? value.replace('#', '') : value}</span>;
                                    return <Counter value={numeric} />;
                                })()}
                                {typeof value === 'string' && value.includes('M') && <span className="text-xl md:text-3xl">M</span>}
                                {typeof value === 'string' && value.includes('K') && <span className="text-xl md:text-3xl">K</span>}
                            </div>
                            {sub && <p className="mt-1 font-grotesk text-[10px] md:text-xs text-white/60">{sub}</p>}</div>
                        )}
                    </div>
                </motion.div>
            );
        };

        const DecryptText = ({ text }) => {
            const cleanText = text ? text.replace(/<[^>]*>/g, '') : "Loading data...";
            return (
                <motion.p initial="hidden" whileInView="visible" viewport={{ once: true, margin: "-10%" }} variants={{ hidden: { opacity: 0 }, visible: { opacity: 1, transition: { staggerChildren: 0.002, delayChildren: 0.1 } } }} className="font-grotesk text-base md:text-lg leading-relaxed text-white/90 lg:text-2xl">
                    {cleanText.split(" ").map((word, i) => (
                        <motion.span key={i} variants={{ hidden: { opacity: 0, filter: "blur(5px)", y: 5 }, visible: { opacity: 1, filter: "blur(0px)", y: 0, transition: { duration: 0.4 } } }} className="inline-block mr-1.5">{word}</motion.span>
                    ))}
                </motion.p>
            );
        };

        const fetchAnimeDetails = async (title, image) => {
            try {
                const kitsuReq = fetch(`https://kitsu.io/api/edge/anime?filter[text]=${encodeURIComponent(title)}`).then(r => r.json());
                const anilistQuery = `query ($search: String) { Media (search: $search, type: ANIME) { genres studios(isMain: true) { nodes { name } } characters(sort: ROLE, perPage: 12) { edges { node { name { full }, image { large } }, role } } externalLinks { site url } } }`;
                const anilistReq = fetch('https://graphql.anilist.co', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' }, body: JSON.stringify({ query: anilistQuery, variables: { search: title } }) }).then(r => r.json());

                const [kitsuRes, anilistRes] = await Promise.all([kitsuReq, anilistReq]);

                if (kitsuRes.data && kitsuRes.data.length > 0 && anilistRes.data && anilistRes.data.Media) {
                    const kItem = kitsuRes.data[0];
                    const kAttr = kItem.attributes;
                    const aMedia = anilistRes.data.Media;
                    const displayTitle = kAttr.canonicalTitle || kAttr.titles.en || kAttr.titles.en_jp;
                    
                    const links = aMedia.externalLinks || [];
                    const officialSites = ['Crunchyroll', 'Netflix', 'Hulu', 'Amazon Prime Video'];
                    const streamingLink = links.find(link => officialSites.includes(link.site)) || links.find(link => link.site === "Official Site") || links[0];
                    const finalStreamingUrl = streamingLink ? streamingLink.url : `https://www.crunchyroll.com/search?q=${encodeURIComponent(displayTitle)}`;
                    const rankValue = kAttr.ratingRank || kAttr.popularityRank || "--";

                    return {
                        id: kItem.id, 
                        title: displayTitle.toUpperCase(), 
                        japanese: kAttr.titles.ja_jp || kAttr.titles.en_jp,
                        score: kAttr.averageRating ? (parseFloat(kAttr.averageRating) / 10).toFixed(1) : "0.0", 
                        rank: `#${rankValue}`, 
                        popularity: kAttr.userCount ? `${(kAttr.userCount / 1000).toFixed(1)}K` : "0K",
                        episodes: kAttr.episodeCount || '?',
                        synopsis: kAttr.synopsis || "No synopsis available.",
                        coverImage: kAttr.coverImage?.original || kAttr.coverImage?.large || kAttr.posterImage?.original || image,
                        tags: aMedia.genres ? aMedia.genres.slice(0, 3) : ['Action'],
                        studio: aMedia.studios?.nodes?.[0]?.name || "Unknown Studio",
                        characters: aMedia.characters?.edges || [],
                        streamingUrl: finalStreamingUrl,
                        image: image 
                    };
                }
            } catch (error) { console.error("Data load failed", error); }
            return null;
        };

        // --- MAIN APP ---
        const App = () => {
            const { scrollY } = useScroll();
            const [appVisible, setAppVisible] = useState(false);
            const [searchOpen, setSearchOpen] = useState(false);
            const [favOpen, setFavOpen] = useState(false);
            const [authOpen, setAuthOpen] = useState(false);
            const [authError, setAuthError] = useState(null);
            const [slideIndex, setSlideIndex] = useState(0);
            const [slidesData, setSlidesData] = useState({});
            const [manualSelection, setManualSelection] = useState(null);
            const [manualData, setManualData] = useState(null);
            const [isShuffling, setIsShuffling] = useState(false);
            const [shufflePreview, setShufflePreview] = useState(null);
            
            // Backend State
            const [user, setUser] = useState(null);
            const [favorites, setFavorites] = useState([]);
            
            // State for Friend Profile Viewing
            const [viewingFriendUid, setViewingFriendUid] = useState(null);

            const currentSlide = HERO_SLIDES[slideIndex];

            // --- FIREBASE AUTH LOGIC ---
            useEffect(() => {
                if (!auth) return;

                const initAuth = async () => {
                      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        try {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } catch (e) {
                            console.warn("Custom token auth failed, falling back to anonymous", e);
                            await signInAnonymously(auth);
                        }
                      } 
                };
                initAuth();

                const unsubscribeAuth = onAuthStateChanged(auth, (currentUser) => {
                    if (currentUser) {
                        setUser(currentUser);
                    } else {
                        signInAnonymously(auth).catch(err => console.error("Auth init failed", err));
                    }
                });
                return () => unsubscribeAuth();
            }, []);

            // --- AUTO-SYNC OLD PROFILES TO PUBLIC DIRECTORY ---
            useEffect(() => {
                if (!user || user.isAnonymous || !db) return;

                const syncPublicProfile = async () => {
                    try {
                        const privateRef = doc(db, 'artifacts', pathAppId, 'users', user.uid, 'settings', 'profile');
                        const publicRef = doc(db, 'artifacts', pathAppId, 'public', 'data', 'profiles', user.uid);
                        
                        const privateSnap = await getDoc(privateRef);
                        if (privateSnap.exists()) {
                            const data = privateSnap.data();
                            await setDoc(publicRef, {
                                uid: user.uid,
                                displayName: data.displayName || "AGENT",
                                avatar: data.avatar || null,
                                agentId: user.uid.slice(0, 8).toUpperCase(),
                                lastSeen: Date.now() 
                            }, { merge: true });
                            console.log("Profile synced to public directory.");
                        }
                    } catch (e) {
                        console.warn("Background profile sync failed (non-critical):", e);
                    }
                };
                
                syncPublicProfile();
            }, [user]);

            // Handle Email/Password Login
            const handleEmailLogin = async (email, password) => {
                setAuthError(null);
                if (!auth) { setAuthError("System Error: Auth module offline."); return; }
                
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    setAuthOpen(false);
                } catch (e) {
                    console.error("Login failed", e);
                    let msg = "Invalid credentials.";
                    if (e.code === 'auth/user-not-found') msg = "Agent identity not recognized.";
                    if (e.code === 'auth/wrong-password') msg = "Access key incorrect.";
                    if (e.code === 'auth/invalid-email') msg = "Invalid ID format.";
                    if (e.code === 'auth/invalid-credential') msg = "Invalid credentials.";
                    setAuthError(msg);
                }
            };

            // Handle Email/Password Registration (With Account Linking)
            const handleEmailRegister = async (email, password) => {
                setAuthError(null);
                if (!auth) { setAuthError("System Error: Auth module offline."); return; }

                try {
                    const credential = EmailAuthProvider.credential(email, password);
                    
                    if (auth.currentUser && auth.currentUser.isAnonymous) {
                        await linkWithCredential(auth.currentUser, credential);
                        console.log("Anonymous account successfully promoted.");
                    } else {
                        await createUserWithEmailAndPassword(auth, email, password);
                    }
                    setAuthOpen(false);
                } catch (e) {
                    console.error("Registration/Linking failed", e);
                    let msg = "Registration failed.";
                    if (e.code === 'auth/email-already-in-use' || e.code === 'auth/credential-already-in-use') {
                        msg = "Identity already registered. Please switch to Login mode.";
                    } else if (e.code === 'auth/weak-password') {
                        msg = "Access key security level too low (min 6 chars).";
                    } else {
                        msg = e.message || "Unknown error during initialization.";
                    }
                    setAuthError(msg);
                }
            };

            const handleLogout = async () => {
                if (!auth) return;
                try {
                    await signOut(auth);
                    window.location.reload(); 
                } catch (e) {
                    console.error("Logout failed", e);
                }
            }

            // --- FIRESTORE LOGIC ---
            useEffect(() => {
                if (!user || !db) return;
                try {
                    const q = collection(db, 'artifacts', pathAppId, 'users', user.uid, 'animeList');
                    const unsubscribe = onSnapshot(q, (snapshot) => {
                        const favs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setFavorites(favs);
                    }, (error) => console.error("Firestore Error", error));
                    return () => unsubscribe();
                } catch (e) { console.error("Firestore hook failed", e); }
            }, [user]);

            const updateEntry = async (animeId, updates) => {
                if (!user || !db) return;
                const docRef = doc(db, 'artifacts', pathAppId, 'users', user.uid, 'animeList', String(animeId));
                try {
                    await updateDoc(docRef, updates);
                } catch (e) {
                    console.error("Failed to update entry", e);
                }
            };

            const deleteEntry = async (animeId) => {
                if (!user || !db) return;
                const docRef = doc(db, 'artifacts', pathAppId, 'users', user.uid, 'animeList', String(animeId));
                try {
                    await deleteDoc(docRef);
                } catch (e) {
                    console.error("Failed to delete entry", e);
                }
            };

            const toggleFavorite = async (animeData) => {
                if (!user || !animeData || !db) return;
                
                if (!animeData.id) return;

                const docId = String(animeData.id);
                const docRef = doc(db, 'artifacts', pathAppId, 'users', user.uid, 'animeList', docId);

                const isFav = favorites.some(f => String(f.id) === docId);

                if (isFav) {
                    await deleteDoc(docRef);
                } else {
                    let totalEps = 0;
                    if (typeof animeData.episodes === 'number') totalEps = animeData.episodes;
                    else if (typeof animeData.episodes === 'string' && animeData.episodes !== '?') {
                        totalEps = parseInt(animeData.episodes) || 0;
                    }

                    await setDoc(docRef, {
                        id: animeData.id,
                        title: animeData.title,
                        image: animeData.coverImage || animeData.image,
                        totalEpisodes: totalEps,
                        watched: 0,
                        status: 'Planning',
                        addedAt: Date.now()
                    });
                }
            };

            useEffect(() => {
                const timer = setInterval(() => {
                    const isHeroVisible = window.scrollY < (window.innerHeight * 0.5);
                    if (isHeroVisible && !searchOpen && !favOpen && !authOpen && !manualSelection && !isShuffling && document.hasFocus()) { 
                        setSlideIndex((prev) => (prev + 1) % HERO_SLIDES.length);
                    }
                }, 8000); 
                return () => clearInterval(timer);
            }, [slideIndex, searchOpen, favOpen, authOpen, manualSelection, isShuffling]);

            useEffect(() => {
                const fetchAllSlides = async () => {
                    const results = await Promise.all(HERO_SLIDES.map(slide => fetchAnimeDetails(slide.query, slide.image)));
                    const dataMap = {};
                    results.forEach((data, i) => { if (data) dataMap[HERO_SLIDES[i].id] = data; });
                    setSlidesData(dataMap);
                };
                fetchAllSlides();
            }, []);

            const handleSearchSelect = async (anime) => {
                setSearchOpen(false);
                window.scrollTo({ top: 0, behavior: 'smooth' });
                setManualSelection(anime); 
                setManualData(null); 
                
                const details = await fetchAnimeDetails(anime.title, anime.image);
                if (details && details.coverImage) {
                    const img = new Image();
                    img.src = details.coverImage;
                    img.onload = () => { setManualData(details); }
                } else {
                     setManualData(details);
                }
            };

            const handleShuffle = async () => {
                if (isShuffling) return;
                setIsShuffling(true);
                setManualSelection({ id: 'shuffling', title: 'ACCESSING MAINFRAME...', image: null }); 
                setManualData(null);
                window.scrollTo({ top: 0, behavior: 'smooth' });
                setShufflePreview({ title: "INITIALIZING", japanese: "æ¤œç´¢ä¸­...", coverImage: null, tags: ["SCANNING", "DATABASE", "RANDOM"] });

                try {
                    const randomOffset = Math.floor(Math.random() * 2000);
                    const res = await fetch(`https://kitsu.io/api/edge/anime?sort=-user_count&page[limit]=1&page[offset]=${randomOffset}`);
                    const json = await res.json();
                    
                    if (json.data && json.data.length > 0) {
                        const anime = json.data[0];
                        const title = anime.attributes.canonicalTitle;
                        const image = anime.attributes.posterImage?.original || anime.attributes.coverImage?.original;
                        const details = await fetchAnimeDetails(title, image);
                        
                        const img = new Image();
                        img.src = image;
                        img.onload = () => {
                            setTimeout(() => {
                                setManualSelection({ id: anime.id, title, image });
                                setManualData(details);
                                setIsShuffling(false);
                                setShufflePreview(null);
                            }, 500);
                        };
                    } else throw new Error("No data");
                } catch (e) { setIsShuffling(false); setManualSelection(null); }
            };

            const activeData = isShuffling ? shufflePreview : (manualSelection ? manualData : slidesData[currentSlide.id]);
            const isLoading = !activeData && (manualSelection || (!slidesData[currentSlide.id] && !isShuffling));
            const activeId = manualSelection ? manualSelection.id : currentSlide.id;
            const activeImage = isShuffling ? null : (activeData?.coverImage || (manualSelection ? manualSelection.image : currentSlide.image));
            const titleText = activeData?.title || (manualSelection ? manualSelection.title : "INITIALIZING");
            const getFontSize = (text) => text.length > 25 ? "text-[6vw] md:text-[7vw]" : text.length > 15 ? "text-[8vw] md:text-[10vw]" : "text-[10vw] md:text-[12vw]";

            const isCurrentFav = activeData && favorites.some(f => String(f.id) === String(activeData.id));

            const yTitle = useTransform(scrollY, [0, 500], [0, 200]);
            const scaleTitle = useTransform(scrollY, [0, 400], [1, 0.6]); 
            const opacityHero = useTransform(scrollY, [0, 600], [1, 0]);
            const scaleHero = useTransform(scrollY, [0, 600], [1, 1.1]);
            const fillOpacity = useTransform(scrollY, [0, 300], [0, 1]);
            const strokeOpacity = useTransform(scrollY, [0, 300], [1, 0]);
            
            const mouseX = useMotionValue(0);
            const mouseY = useMotionValue(0);
            const springConfig = { damping: 40, stiffness: 300 };
            const rotateX = useSpring(useTransform(mouseY, [-0.5, 0.5], [3, -3]), springConfig);
            const rotateY = useSpring(useTransform(mouseX, [-0.5, 0.5], [-3, 3]), springConfig);

            const handleMouseMove = useCallback((e) => {
                const { innerWidth, innerHeight } = window;
                mouseX.set((e.clientX / innerWidth) - 0.5);
                mouseY.set((e.clientY / innerHeight) - 0.5);
            }, [mouseX, mouseY]);

            return (
                <div 
                    className="min-h-screen bg-[#050505] text-white overflow-x-hidden transition-colors duration-1000" 
                    onMouseMove={handleMouseMove}
                    style={{ '--accent': manualSelection ? '#facc15' : currentSlide.color }}
                >
                    <IntroSequence onReveal={() => setAppVisible(true)} onComplete={() => setAppVisible(true)} />
                    <SearchOverlay isOpen={searchOpen} onClose={() => setSearchOpen(false)} onSelect={handleSearchSelect} />
                    <FavoritesOverlay 
                        isOpen={favOpen} 
                        onClose={() => setFavOpen(false)} 
                        favorites={favorites} 
                        onSelect={handleSearchSelect} 
                        onUpdateEntry={updateEntry}
                        onDeleteEntry={deleteEntry}
                    />
                    <ProfileOverlay 
                        isOpen={authOpen} 
                        onClose={() => { setAuthOpen(false); setAuthError(null); }} 
                        user={user} 
                        onLogin={handleEmailLogin}
                        onRegister={handleEmailRegister} 
                        onLogout={handleLogout} 
                        error={authError}
                        clearError={() => setAuthError(null)}
                        favorites={favorites}
                        db={db}
                        pathAppId={pathAppId}
                        onViewProfile={setViewingFriendUid}
                    />
                    <FriendProfileModal 
                        isOpen={!!viewingFriendUid} 
                        onClose={() => setViewingFriendUid(null)} 
                        targetUid={viewingFriendUid}
                        db={db}
                        pathAppId={pathAppId}
                    />

                    <motion.div initial={{ opacity: 0 }} animate={{ opacity: appVisible ? 1 : 0 }} transition={{ duration: 1.5, ease: "easeOut" }} style={{ width: '100%' }}>
                        <motion.nav style={{ opacity: fillOpacity }} className="fixed top-0 left-0 z-50 w-full border-b border-white/10 bg-black/80 backdrop-blur-md px-4 py-3 md:px-6 md:py-4 flex justify-between items-center will-change-opacity">
                            <span className="font-oswald text-lg md:text-xl font-bold tracking-tighter accent-text">ANIMESMERENS</span>
                            <div className="flex gap-4 items-center">
                                <button onClick={() => setSearchOpen(true)} className="rounded-full bg-white/10 p-2 hover:bg-white/20 transition active:scale-95 group"><Search size={18} className="text-white group-hover:text-[var(--accent)] transition-colors"/></button>
                                <button onClick={() => setFavOpen(true)} className="rounded-full bg-white/10 p-2 hover:bg-white/20 transition active:scale-95 group relative">
                                    <Heart size={18} className={`${favorites.length > 0 ? 'text-[var(--accent)] fill-[var(--accent)]' : 'text-white'} transition-colors`} />
                                </button>
                                <button onClick={() => setAuthOpen(true)} className="rounded-full bg-white/10 p-2 hover:bg-white/20 transition active:scale-95 group relative border border-white/5 hover:border-[var(--accent)]">
                                    {user && !user.isAnonymous && user.photoURL ? (
                                        <div className="w-[18px] h-[18px] rounded-full overflow-hidden">
                                            <img src={user.photoURL} className="w-full h-full object-cover" alt="User" />
                                        </div>
                                    ) : (
                                        <User size={18} className="text-white group-hover:text-[var(--accent)] transition-colors"/>
                                    )}
                                </button>
                                <button onClick={() => activeData?.streamingUrl && window.open(activeData.streamingUrl, '_blank')} className="rounded-full accent-bg px-3 py-2 md:px-6 font-oswald text-black font-bold uppercase tracking-wider transition hover:brightness-110 active:scale-95 flex items-center gap-2">
                                    <span className="hidden md:inline">Watch Now</span> <Play size={16} fill="black" />
                                </button>
                            </div>
                        </motion.nav>

                        <section className="relative h-screen w-full overflow-hidden flex items-center justify-center perspective-1000">
                            <div className="absolute inset-0 z-0 bg-black">
                                <AnimatePresence initial={false} mode="popLayout">
                                    {isShuffling ? (
                                        <motion.div key="shuffle-skeleton" className="absolute inset-0 h-full w-full bg-black z-50 overflow-hidden" initial={{ opacity: 1 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }} transition={{ duration: 0.1 }} />
                                    ) : (
                                        <motion.div key={activeId} className="absolute inset-0 h-full w-full" initial={{ opacity: 0, scale: 1.15 }} animate={{ opacity: 1, scale: 1 }} exit={{ opacity: 0, scale: 0.95 }} transition={{ duration: 1.2, ease: [0.165, 0.84, 0.44, 1] }}>
                                            <motion.div style={{ rotateX, rotateY, scale: scaleHero, opacity: opacityHero }} className="h-full w-full">
                                                <div className="absolute inset-0 bg-gradient-to-t from-[#050505] via-[#050505]/40 to-transparent z-10" />
                                                <div className="absolute inset-0 bg-black/30 z-10" />
                                                {activeImage && <SmoothHeroImage src={activeImage} alt={activeId} />}
                                            </motion.div>
                                        </motion.div>
                                    )}
                                </AnimatePresence>
                            </div>

                            <div className="relative z-20 flex flex-col items-center justify-center w-full px-4 text-center">
                                <div className="relative w-full flex justify-center">
                                    <AnimatePresence mode="wait">
                                        <motion.div key={isShuffling ? 'shuffling-text' : activeId} initial={{ y: 20, opacity: 0 }} animate={{ y: 0, opacity: 1 }} exit={{ y: -20, opacity: 0 }} transition={{ duration: 0.4 }} className="relative w-full max-w-[95vw] flex justify-center will-change-transform">
                                            <motion.h1 style={{ y: yTitle, scale: scaleTitle, opacity: strokeOpacity }} className={`font-oswald ${getFontSize(titleText)} py-4 leading-[0.9] font-bold text-stroke tracking-tighter uppercase text-center break-words`}>{titleText}</motion.h1>
                                            <motion.h1 style={{ y: yTitle, scale: scaleTitle, opacity: fillOpacity, position: 'absolute', top: 0, left: 0, right: 0, color: '#fff' }} className={`font-oswald ${getFontSize(titleText)} py-4 leading-[0.9] font-bold tracking-tighter uppercase text-center break-words pointer-events-none`}>{titleText}</motion.h1>
                                        </motion.div>
                                    </AnimatePresence>
                                </div>

                                <motion.div style={{ opacity: opacityHero, y: yTitle }} className="mt-8 flex flex-col items-center gap-4 will-change-transform">
                                    <div className="flex flex-wrap justify-center gap-2">
                                        {(activeData?.tags || []).map((tag, i) => <span key={i} className="border border-white/20 bg-white/5 px-3 py-1 text-xs font-grotesk uppercase tracking-widest backdrop-blur-sm">{tag}</span>)}
                                        {isLoading && <span className="text-xs font-grotesk animate-pulse accent-text">{isShuffling ? "RANDOMIZING SELECTION..." : "LOADING ASSETS..."}</span>}
                                    </div>
                                    <div className="flex items-center gap-4 mt-2">
                                        <AnimatePresence mode="wait">
                                            <motion.p key={activeId} initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }} className="font-grotesk text-white/60 tracking-widest text-sm">{activeData?.japanese}</motion.p>
                                        </AnimatePresence>
                                        {activeData && !isLoading && (
                                            <button 
                                                onClick={() => toggleFavorite(activeData)}
                                                className="group relative p-2 rounded-full border border-white/10 bg-white/5 hover:bg-white/10 transition-colors"
                                            >
                                                <Heart 
                                                    size={20} 
                                                    className={`transition-all duration-300 ${isCurrentFav ? 'fill-[var(--accent)] text-[var(--accent)]' : 'text-white/60 group-hover:text-white'}`} 
                                                />
                                            </button>
                                        )}
                                    </div>
                                </motion.div>
                            </div>

                            <div className="absolute bottom-10 right-10 z-30 flex items-center gap-6">
                                <button onClick={handleShuffle} disabled={isShuffling} className={`group rounded-full border border-white/10 bg-black/20 p-2 backdrop-blur-sm transition-all active:scale-90 ${isShuffling ? 'opacity-50 cursor-not-allowed border-[var(--accent)] animate-spin' : 'hover:bg-white/10 hover:border-[var(--accent)]'}`} title="Random Anime"><Shuffle size={16} className={`text-white/70 transition-colors ${!isShuffling && 'group-hover:text-white'}`} /></button>
                                {manualSelection && <button onClick={() => { setManualSelection(null); setManualData(null); }} className="flex items-center gap-2 px-4 py-2 rounded-full border border-white/10 bg-red-500/20 text-white hover:bg-red-500/40 backdrop-blur-md transition-colors mr-4 active:scale-95"><X size={16} /> <span className="text-xs font-bold uppercase tracking-widest">Close Entry</span></button>}
                                {!manualSelection && !isShuffling && (
                                    <div className="flex gap-2 items-center">
                                        {HERO_SLIDES.map((_, idx) => <div key={idx} onClick={() => setSlideIndex(idx)} className={`h-1 cursor-pointer transition-all duration-500 rounded-full ${idx === slideIndex ? 'w-8 accent-bg' : 'w-4 bg-white/30 hover:bg-white'}`} />)}
                                        <button onClick={() => setSlideIndex((p) => (p - 1 + HERO_SLIDES.length) % HERO_SLIDES.length)} className="group rounded-full border border-white/10 bg-black/20 p-2 backdrop-blur-sm transition-all hover:bg-white/10 hover:border-[var(--accent)] ml-4 active:scale-90"><ChevronLeft size={16} className="text-white/70 transition-colors group-hover:text-white" /></button>
                                        <button onClick={() => setSlideIndex((p) => (p + 1) % HERO_SLIDES.length)} className="group rounded-full border border-white/10 bg-black/20 p-2 backdrop-blur-sm transition-all hover:bg-white/10 hover:border-[var(--accent)] active:scale-90"><ChevronRight size={16} className="text-white/70 transition-colors group-hover:text-white" /></button>
                                    </div>
                                )}
                            </div>
                        </section>

                        <main className="relative z-30 mx-auto max-w-7xl px-4 sm:px-6 pb-32">
                            <section className="py-24 grid grid-cols-1 lg:grid-cols-12 gap-12 border-b border-white/10 items-start">
                                <div className="lg:col-span-4 sticky top-24">
                                    <motion.div key={activeId} initial={{ opacity: 0, x: -20 }} whileInView={{ opacity: 1, x: 0 }} viewport={{ once: true }} transition={{ duration: 0.6 }}>
                                        <span className="block font-oswald accent-text text-sm tracking-widest mb-4">/// SYSTEM LOG: SYNOPSIS</span>
                                        <h2 className="font-oswald text-4xl uppercase font-bold leading-tight">{(activeData?.title || "ARCHIVE").split(":")[0]} <br/><span className="text-stroke-thin text-white">Archives</span></h2>
                                    </motion.div>
                                </div>
                                <div className="lg:col-span-8 min-h-[200px]">
                                    {isLoading ? <div className="h-40 w-full animate-pulse bg-white/5 rounded-xl border border-white/5" /> : <div key={activeId}><DecryptText text={activeData?.synopsis || "Accessing database..."} /></div>}
                                </div>
                            </section>

                            <section className="py-24">
                                <div className="flex items-end justify-between mb-12">
                                    <h2 className="font-oswald text-5xl uppercase font-bold">Performance <span className="accent-text">Metrics</span></h2>
                                    <div className="hidden md:flex gap-2 text-xs font-grotesk text-white/40 uppercase tracking-widest"><span>Live Data</span><span className="animate-pulse text-green-500">â—</span></div>
                                </div>
                                <div className="grid grid-cols-2 md:grid-cols-2 lg:grid-cols-4 gap-3 md:gap-4 h-auto md:h-[400px]">
                                    <div className="col-span-2 md:col-span-2 md:row-span-2 h-full"><BentoCard title="Global Score" value={activeData?.score || 0} isScore={true} icon={Star} color={manualSelection ? '#facc15' : currentSlide.color} /></div>
                                    <BentoCard title="Rank" value={activeData?.rank || "#--"} sub="All Time" icon={TrendingUp} delay={0.1} color={manualSelection ? '#facc15' : currentSlide.color} />
                                    <BentoCard title="Popularity" value={activeData?.popularity || "0K"} sub="Active Trackers" icon={Users} delay={0.2} color={manualSelection ? '#facc15' : currentSlide.color} />
                                    <BentoCard title="Episodes" value={activeData?.episodes || 0} sub="24min / ep" icon={Clock} delay={0.3} color={manualSelection ? '#facc15' : currentSlide.color} />
                                    <BentoCard title="Studio" value={activeData?.studio || "Loading..."} isStudio={true} icon={ArrowUpRight} delay={0.4} color={manualSelection ? '#facc15' : currentSlide.color} />
                                </div>
                            </section>

                            <section className="py-24 overflow-hidden">
                                <div className="mb-12 px-2"><h2 className="font-oswald text-4xl uppercase font-bold text-center md:text-left">Key <span className="text-stroke-thin text-white">Personnel</span></h2></div>
                                <div className="relative w-full overflow-hidden mask-linear-gradient">
                                    <div className="absolute left-0 top-0 z-10 h-full w-24 bg-gradient-to-r from-[#050505] to-transparent" />
                                    <div className="absolute right-0 top-0 z-10 h-full w-24 bg-gradient-to-l from-[#050505] to-transparent" />
                                    
                                    <div className="flex gap-6 w-max animate-marquee hover:[animation-play-state:paused] gpu-accelerated">
                                        {(activeData?.characters && activeData.characters.length > 0) ? 
                                            [...activeData.characters, ...activeData.characters, ...activeData.characters, ...activeData.characters].map((edge, idx) => (
                                            <div key={`${edge.node.name.full}-${idx}`} className="relative flex-shrink-0 w-[200px] aspect-[2/3] group cursor-pointer transition-transform duration-300 hover:scale-105">
                                                <div className="absolute inset-0 rounded-xl overflow-hidden bg-white/5 border border-white/5 group-hover:border-[var(--accent)] transition-colors">
                                                    <img loading="lazy" src={edge.node.image.large} alt={edge.node.name.full} className="h-full w-full object-cover grayscale group-hover:grayscale-0 transition-all duration-500" />
                                                    <div className="absolute inset-0 bg-gradient-to-t from-black/90 via-transparent to-transparent opacity-80" />
                                                    <div className="absolute bottom-0 left-0 p-4 w-full">
                                                        <h4 className="font-oswald text-lg uppercase font-bold text-white transition-colors accent-text-hover truncate">{edge.node.name.full}</h4>
                                                        <p className="font-grotesk text-xs text-white/60">{edge.role}</p>
                                                    </div>
                                                </div>
                                            </div>
                                        )) : (
                                            <div className="flex items-center justify-center w-[80vw] h-[200px] border border-white/5 rounded-xl bg-white/5">
                                                <span className="text-white/30 font-grotesk animate-pulse">Scanning Personnel Database...</span>
                                            </div>
                                        )}
                                    </div>
                                </div>
                                <div className="mt-4 flex justify-center text-xs text-white/30 font-grotesk tracking-widest">/// HOVER TO INSPECT</div>
                            </section>
                        </main>

                        <footer className="border-t border-white/10 bg-black py-16 text-center relative overflow-hidden">
                            <h2 className="font-oswald text-[15vw] leading-none text-white/5 uppercase select-none pointer-events-none transition-all duration-1000">{(activeData?.title || "ANIMESMERENS").split(" ")[0]}</h2>
                            <div className="font-grotesk text-sm text-white/40 mt-[-5vw] relative z-10 flex flex-col gap-2 items-center">
                                <span>Â© 2026 ANIMESMERENS PROJECT.</span>
                                <span className="text-white/20 text-xs">Take a break. Hydrate.</span>
                            </div>
                        </footer>
                    </motion.div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>
